<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAB MANAGER LUXURY - Full Control</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            databaseURL: "https://tbkxnub-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db; window.dbRef = ref; window.dbSet = set; 
        window.dbOnValue = onValue; window.dbRemove = remove;
    </script>

    <style>
        :root {
            --lux-blue: #004aad;
            --lux-green: #2ecc71;
            --lux-orange: #f39c12;
            --sidebar-dark: #001529;
        }

        * { box-sizing: border-box; font-family: "Times New Roman", Times, serif; }
        body { margin: 0; background: #f0f2f5; display: flex; }

        /* Sidebar */
        .sidebar {
            width: 280px; height: 100vh; position: fixed;
            background: var(--sidebar-dark); color: white; padding: 20px 15px;
            overflow-y: auto; z-index: 1000;
        }

        .brand { text-align: center; margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        .brand h2 { margin: 0; font-size: 20px; color: var(--lux-green); }

        .nav-btn {
            width: 100%; padding: 12px 15px; border-radius: 10px; border: none;
            background: var(--lux-blue); color: white; display: flex; 
            align-items: center; justify-content: space-between;
            cursor: pointer; margin-bottom: 8px; font-weight: bold;
        }
        .btn-purple { background: #8e44ad; }

        .sub-menu { 
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;
            padding-left: 10px; display: flex; flex-direction: column; gap: 4px;
        }
        .sub-menu.show { max-height: 1200px; margin-bottom: 15px; }

        .sub-item {
            padding: 10px 12px; border-radius: 8px; font-size: 14px;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05); transition: 0.2s;
        }
        .sub-item:hover { background: rgba(255,255,255,0.15); border-left: 4px solid var(--lux-green); }

        /* Main Area */
        .main { margin-left: 280px; flex-grow: 1; padding: 30px; }
        .header {
            background: linear-gradient(90deg, var(--lux-blue), var(--lux-green));
            padding: 20px; border-radius: 15px; color: white; margin-bottom: 25px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card { background: white; border-radius: 15px; padding: 25px; border: 1px solid #ddd; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        
        .search-input { flex-grow: 1; padding: 10px 20px; border-radius: 20px; border: 1px solid #000; min-width: 200px; }

        .btn-action {
            padding: 10px 20px; border-radius: 20px; border: 1px solid #000;
            font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.3s;
        }
        .btn-blue { background: var(--lux-blue); color: white; }
        .btn-green { background: var(--lux-green); color: white; }
        .btn-orange { background: var(--lux-orange); color: white; }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }

        /* Table */
        .table-wrap { border: 2px solid #000; border-radius: 10px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f1f5f9; padding: 12px; border: 1px solid #000; color: var(--lux-blue); }
        td { padding: 10px; border: 1px solid #000; text-align: center; }
        tbody tr:hover { background: #e8f4fd; }

        .btn-del-row { color: #e74c3c; border: none; background: none; cursor: pointer; font-size: 16px; }
        .rotate { transform: rotate(180deg); }
        .arrow { transition: 0.3s; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand">
        <h2>LAB MANAGER</h2>
        <small style="color: var(--lux-green)">LUXURY SYSTEM</small>
    </div>

    <button class="nav-btn" onclick="toggleMenu('menu_chinh', this); loadData('dstong_chinh', 'T·ªîNG THI·∫æT B·ªä CH√çNH', 'dstong')">
        <span><i class="fas fa-microscope"></i> T·ªîNG THI·∫æT B·ªä CH√çNH</span>
        <i class="fas fa-chevron-down arrow"></i>
    </button>
    <div id="menu_chinh" class="sub-menu">
        <div class="sub-item" onclick="loadData('huyet_hoc', 'ü©∏ HUY·∫æT H·ªåC', 'tbchinh', 'Huy·∫øt h·ªçc')"><span>ü©∏ Huy·∫øt h·ªçc</span></div>
        <div class="sub-item" onclick="loadData('mien_dich', 'üß´ MI·ªÑN D·ªäCH', 'tbchinh', 'Mi·ªÖn d·ªãch')"><span>üß´ Mi·ªÖn d·ªãch</span></div>
        <div class="sub-item" onclick="loadData('sinh_hoa', '‚öóÔ∏è SINH H√ìA', 'tbchinh', 'Sinh h√≥a')"><span>‚öóÔ∏è Sinh h√≥a</span></div>
        <div class="sub-item" onclick="loadData('vi_sinh', 'ü¶† VI SINH', 'tbchinh', 'Vi sinh')"><span>ü¶† Vi sinh</span></div>
        <div class="sub-item" onclick="loadData('shpt', 'üß¨ SINH H·ªåC PH√ÇN T·ª¨', 'tbchinh', 'SHPT')"><span>üß¨ SHPT</span></div>
    </div>

    <button class="nav-btn btn-purple" onclick="toggleMenu('menu_phu', this); loadData('dstong_phu', 'T·ªîNG THI·∫æT B·ªä PH·ª§', 'dstongphu')">
        <span><i class="fas fa-tools"></i> T·ªîNG THI·∫æT B·ªä PH·ª§</span>
        <i class="fas fa-chevron-down arrow"></i>
    </button>
    <div id="menu_phu" class="sub-menu">
        <div class="sub-item" onclick="loadData('may_ly_tam', 'üîÑ M√ÅY LY T√ÇM', 'tbphu', 'M√°y ly t√¢m')"><span>üîÑ M√°y ly t√¢m</span></div>
        <div class="sub-item" onclick="loadData('tu_lanh', '‚ùÑÔ∏è T·ª¶ L·∫†NH', 'tbphu', 'T·ªß l·∫°nh')"><span>‚ùÑÔ∏è T·ªß l·∫°nh</span></div>
        <div class="sub-item" onclick="loadData('tu_am_sau', 'üå°Ô∏è T·ª¶ √ÇM S√ÇU', 'tbphu', 'T·ªß √¢m s√¢u')"><span>üå°Ô∏è T·ªß √¢m s√¢u</span></div>
        <div class="sub-item" onclick="loadData('nhiet_ke', 'üå°Ô∏è NHI·ªÜT K·∫æ', 'tbphu', 'Nhi·ªát k·∫ø')"><span>üå°Ô∏è Nhi·ªát k·∫ø</span></div>
        <div class="sub-item" onclick="loadData('nhiet_ke_phong', 'üè† NHI·ªÜT K·∫æ PH√íNG', 'tbphu', 'Nhi·ªát k·∫ø ph√≤ng')"><span>üè† Nhi·ªát k·∫ø ph√≤ng</span></div>
        <div class="sub-item" onclick="loadData('tu_atsh', 'üõ°Ô∏è T·ª¶ ATSH', 'tbphu', 'T·ªß ATSH')"><span>üõ°Ô∏è T·ªß ATSH</span></div>
        <div class="sub-item" onclick="loadData('pipette', 'üß™ PIPETTE', 'tbphu', 'Pipette')"><span>üß™ Pipette</span></div>
        <div class="sub-item" onclick="loadData('noi_hap', 'üî• N·ªíI H·∫§P', 'tbphu', 'N·ªìi h·∫•p')"><span>üî• N·ªìi h·∫•p</span></div>
        <div class="sub-item" onclick="loadData('tu_am', 'üì¶ T·ª¶ ·∫§M', 'tbphu', 'T·ªß ·∫•m')"><span>üì¶ T·ªß ·∫•m</span></div>
        <div class="sub-item" onclick="loadData('khac', '‚ûï KH√ÅC', 'tbphu', 'Kh√°c')"><span>‚ûï Kh√°c</span></div>
    </div>

    <div style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
        <div class="sub-item" onclick="loadData('ke_hoach_goc', 'üìÖ SO·∫†N TH·∫¢O K·∫æ HO·∫†CH', 'kehoach')"><b>üìÖ SO·∫†N TH·∫¢O KH</b></div>
        <div id="archive_kh_list" class="sub-menu show"></div>

        <div class="sub-item" onclick="loadData('kq_hieu_chuan_goc', 'üìä SO·∫†N TH·∫¢O K·∫æT QU·∫¢', 'kqhc')"><b>üìä SO·∫†N TH·∫¢O KQ</b></div>
        <div id="archive_kq_list" class="sub-menu show"></div>
    </div>
</div>

<div class="main">
    <div class="header">
        <div><h1 id="title" style="margin:0; font-size: 22px;">H·ªÜ TH·ªêNG QU·∫¢N L√ù LUXURY</h1></div>
        <div style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px;">
            <i class="fas fa-check-circle"></i> ƒê√£ ƒë·ªìng b·ªô
        </div>
    </div>

    <div class="card">
        <div class="toolbar">
            <input type="text" id="search" class="search-input" placeholder="T√¨m ki·∫øm nhanh d·ªØ li·ªáu..." oninput="render()">
            <button class="btn-action btn-blue" onclick="addRow()"><i class="fas fa-plus"></i> Th√™m d√≤ng</button>
            <button class="btn-action btn-green" onclick="exportExcel()"><i class="fas fa-file-excel"></i> Xu·∫•t Excel</button>
            
            <button id="btn-xu·∫•t-kh" class="btn-action btn-orange" style="display:none;" onclick="exportSnapshot('archives_ke_hoach', 'KH')"><i class="fas fa-save"></i> XU·∫§T KH</button>
            <button id="btn-xu·∫•t-kq" class="btn-action btn-orange" style="display:none;" onclick="exportSnapshot('archives_ket_qua', 'KQ')"><i class="fas fa-save"></i> XU·∫§T KQ</button>
        </div>

        <div class="table-wrap">
            <table>
                <thead id="thead"></thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
let currentMode="", currentKey="", currentGroup="", currentData=[];

const COLS = {
    dstong: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Model","Serial","V·ªã tr√≠","S·∫£n xu·∫•t","Cung ·ª©ng","Li√™n h·ªá","Ph·ª• tr√°ch"],
    tbchinh: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Model","Serial","V·ªã tr√≠","S·∫£n xu·∫•t","Cung ·ª©ng","Li√™n h·ªá","T√¨nh tr·∫°ng","Ph·ª• tr√°ch"],
    dstongphu: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Ch·ªßng lo·∫°i","Serial","Nh√† s·∫£n xu·∫•t","N∆∞·ªõc","Ng√†y l·∫Øp","C∆° s·ªü","V·ªã tr√≠","T√¨nh tr·∫°ng"],
    tbphu: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Ch·ªßng lo·∫°i","Serial","Nh√† s·∫£n xu·∫•t","N∆∞·ªõc","Ng√†y l·∫Øp","C∆° s·ªü","V·ªã tr√≠","T√¨nh tr·∫°ng"],
    kqhc: ["M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Model","Serial","Ng√†y hi·ªáu chu·∫©n","Ng√†y ti·∫øp theo","K·∫øt qu·∫£","ƒê∆°n v·ªã","Ghi ch√∫"],
    kehoach: ["M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Serial","Th·ªùi gian th·ª±c hi·ªán","N·ªôi dung y√™u c·∫ßu","Ti√™u ch√≠ ch·∫•p nh·∫≠n","Ghi ch√∫"]
};

function toggleMenu(id, btn) {
    const m = document.getElementById(id);
    const a = btn.querySelector('.arrow');
    m.classList.toggle('show');
    a.classList.toggle('rotate');
}

function loadData(key, title, mode, group = "") {
    currentKey = key; currentMode = mode; currentGroup = group;
    document.getElementById("title").innerText = title;
    
    // Hi·ªÉn th·ªã n√∫t Xu·∫•t KH/KQ khi ƒë√∫ng m·ª•c
    document.getElementById("btn-xu·∫•t-kh").style.display = (key === 'ke_hoach_goc') ? "flex" : "none";
    document.getElementById("btn-xu·∫•t-kq").style.display = (key === 'kq_hieu_chuan_goc') ? "flex" : "none";

    window.dbOnValue(window.dbRef(window.db, key), (snapshot) => {
        const val = snapshot.val();
        currentData = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
        render();
    });
}

function render() {
    const cols = COLS[currentMode] || [];
    const q = document.getElementById("search").value.toLowerCase();
    document.getElementById("thead").innerHTML = `<tr><th>STT</th>${cols.map(c => `<th>${c}</th>`).join("")}<th>X√≥a</th></tr>`;
    
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";
    let displaySTT = 1;

    currentData.forEach((row, index) => {
        if(q && !Object.values(row).some(v => String(v).toLowerCase().includes(q))) return;
        
        const tr = document.createElement("tr");
        let html = `<td><b>${displaySTT++}</b></td>`;
        cols.forEach(col => {
            html += `<td contenteditable="true" onblur="updateCell(${index}, '${col}', this.innerText)">${row[col] || ""}</td>`;
        });
        html += `<td><button class="btn-del-row" onclick="deleteRow(${index})">‚úï</button></td>`;
        tr.innerHTML = html;
        tbody.appendChild(tr);
    });
}

async function updateCell(idx, col, val) {
    if(currentData[idx][col] === val.trim()) return;
    currentData[idx][col] = val.trim();
    await window.dbSet(window.dbRef(window.db, currentKey), currentData);
}

async function addRow() {
    let obj = {};
    COLS[currentMode].forEach(c => obj[c] = (c === "Nh√≥m" ? currentGroup : ""));
    currentData.push(obj);
    await window.dbSet(window.dbRef(window.db, currentKey), currentData);
}

async function deleteRow(idx) {
    if(confirm("X√°c nh·∫≠n x√≥a d√≤ng n√†y? STT s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông c·∫≠p nh·∫≠t l·∫°i.")) {
        currentData.splice(idx, 1);
        await window.dbSet(window.dbRef(window.db, currentKey), currentData);
    }
}

async function exportSnapshot(folder, pref) {
    const name = prompt("Nh·∫≠p t√™n b·∫£n xu·∫•t (V√≠ d·ª•: Th√°ng 1-2026):", pref + "-" + new Date().toLocaleDateString('vi-VN'));
    if(!name) return;
    // Ch·∫ø ƒë·ªô l∆∞u b·∫£n snapshot (kh√¥ng ·∫£nh h∆∞·ªüng d·ªØ li·ªáu g·ªëc)
    await window.dbSet(window.dbRef(window.db, `${folder}/${name}`), currentData);
    alert("ƒê√£ xu·∫•t d·ªØ li·ªáu v√†o √¥ con th√†nh c√¥ng!");
}

function loadArchives() {
    window.dbOnValue(window.dbRef(window.db, 'archives_ke_hoach'), (s) => renderMenu(s.val(), 'archive_kh_list', 'archives_ke_hoach', 'kehoach'));
    window.dbOnValue(window.dbRef(window.db, 'archives_ket_qua'), (s) => renderMenu(s.val(), 'archive_kq_list', 'archives_ket_qua', 'kqhc'));
}

function renderMenu(data, id, folder, mode) {
    const div = document.getElementById(id); div.innerHTML = "";
    if(data) Object.keys(data).forEach(k => {
        const item = document.createElement("div");
        item.className = "sub-item";
        item.innerHTML = `
            <span onclick="loadData('${folder}/${k}', 'B·∫¢N L∆ØU: ${k}', '${mode}')"><i class="fas fa-file-alt"></i> ${k}</span>
            <i class="fas fa-trash-alt" style="color:#ff7675; cursor:pointer;" onclick="deleteArchive('${folder}', '${k}')"></i>`;
        div.appendChild(item);
    });
}

async function deleteArchive(folder, k) {
    if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n l∆∞u n√†y kh√¥ng?")) {
        await window.dbRemove(window.dbRef(window.db, `${folder}/${k}`));
    }
}

function exportExcel() {
    const ws = XLSX.utils.json_to_sheet(currentData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, "Lab_Luxury_Export.xlsx");
}

window.onload = () => { loadArchives(); loadData('dstong_chinh', 'T·ªîNG THI·∫æT B·ªä CH√çNH', 'dstong'); };
</script>
</body>
</html>