<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAB MANAGER - BV UNG B∆Ø·ªöU</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            databaseURL: "https://tbkxnub-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.dbPath = "users/-OiHXtd0s_Vjtd2VM2fN/name/";
        window.db = db; window.dbRef = ref; window.dbSet = set; 
        window.dbOnValue = onValue; window.dbRemove = remove;
    </script>

    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.95);
            --primary: #0f172a;
            --accent: #3b82f6;
            --gradient: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            --sidebar-w: 280px;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { margin: 0; background: #e2e8f0; display: flex; min-height: 100vh; color: #1e293b; }

        /* Sidebar l·ªông l·∫´y */
        .sidebar { 
            width: var(--sidebar-w); 
            background: var(--primary); 
            color: white; 
            padding: 20px 0; 
            display: flex; 
            flex-direction: column;
            box-shadow: 4px 0 15px rgba(0,0,0,0.2);
            z-index: 100;
        }
        .logo-box { padding: 0 20px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo-box img { width: 70px; filter: drop-shadow(0 0 8px #3b82f6); background: white; border-radius: 50%; padding: 5px; }
        .brand-name { display: block; font-size: 20px; font-weight: 800; margin-top: 10px; letter-spacing: 1px; color: #60a5fa; }

        .menu-scroll { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .menu-scroll::-webkit-scrollbar { width: 5px; }
        .menu-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .nav-label { font-size: 11px; color: #64748b; font-weight: 700; margin: 20px 0 10px 5px; text-transform: uppercase; letter-spacing: 1.5px; }

        .menu-item { 
            padding: 12px 15px; border-radius: 10px; margin-bottom: 5px; cursor: pointer; 
            display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .menu-item:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
        .menu-item i { width: 20px; text-align: center; }
        
        .active-blue { background: #2563eb !important; box-shadow: 0 4px 12px rgba(37,99,235,0.4); }
        .active-orange { background: #ea580c !important; box-shadow: 0 4px 12px rgba(234,88,12,0.4); }
        .active-purple { background: #9333ea !important; box-shadow: 0 4px 12px rgba(147,51,234,0.4); }

        .submenu { display: none; padding-left: 20px; margin: 5px 0 10px; border-left: 1px solid #334155; }
        .sub-item { 
            padding: 8px 15px; font-size: 13px; color: #94a3b8; cursor: pointer; border-radius: 8px;
            transition: 0.2s; display: flex; justify-content: space-between; align-items: center;
        }
        .sub-item:hover { color: white; background: rgba(255,255,255,0.05); }

        /* Main Area */
        .main { flex-grow: 1; padding: 25px; max-width: calc(100% - var(--sidebar-w)); }
        .header-card { 
            background: var(--gradient); padding: 30px; border-radius: 20px; color: white; 
            box-shadow: 0 10px 25px rgba(30,58,138,0.2); position: relative; overflow: hidden; margin-bottom: 25px;
        }
        .header-card::after { content: ""; position: absolute; right: -50px; top: -50px; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%; }

        .content-box { background: var(--glass); border-radius: 20px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid white; }

        .toolbar { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { 
            padding: 10px 20px; border-radius: 12px; font-weight: 600; border: none; cursor: pointer; 
            display: flex; align-items: center; gap: 8px; color: white; transition: 0.3s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-add { background: #0f172a; }
        .btn-excel { background: #10b981; }
        .btn-save { background: #f59e0b; box-shadow: 0 4px 10px rgba(245,158,11,0.3); }

        .search-container { position: relative; flex-grow: 1; }
        .search-container i { position: absolute; left: 15px; top: 12px; color: #94a3b8; }
        .search-input { width: 100%; padding: 10px 10px 10px 40px; border-radius: 12px; border: 1px solid #e2e8f0; outline: none; transition: 0.3s; }
        .search-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

        /* Table Style */
        .table-container { overflow: auto; max-height: 60vh; border-radius: 12px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 13px; }
        th { background: #f8fafc; color: #475569; padding: 15px; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; text-align: center; color: #334155; }
        tr:hover td { background: #f1f7ff; }
        
        [contenteditable="true"] { outline: none; padding: 5px; border-radius: 4px; }
        [contenteditable="true"]:focus { background: #fff; box-shadow: inset 0 0 0 1px #3b82f6; }

        .arrow { font-size: 10px; transition: 0.3s; margin-left: auto; }
        .rotated { transform: rotate(90deg); }
    </style>
</head>

<body>

<div class="sidebar">
    <div class="logo-box">
        <img src="https://bvub.vn/wp-content/uploads/2021/05/logo-ub.png" alt="Logo">
        <span class="brand-name">LAB MANAGER</span>
    </div>

    <div class="menu-scroll">
        <div class="nav-label">H·ªá th·ªëng danh m·ª•c</div>
        
        <div class="menu-item active-orange" onclick="loadData('ds_tong', 'üì¶ T·ªîNG THI·∫æT B·ªä CH√çNH', 'dstong')">
            <i class="fas fa-layer-group"></i> <span>T·ªîNG THI·∫æT B·ªä CH√çNH</span>
        </div>

        <div class="menu-item active-blue" onclick="toggleSubmenu('sub_chinh', this)">
            <i class="fas fa-microscope"></i> <span>THI·∫æT B·ªä CH√çNH</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div id="sub_chinh" class="submenu">
            <div class="sub-item" onclick="loadData('tb_chinh/Huy·∫øt h·ªçc', 'ü©∏ HUY·∫æT H·ªåC', 'tbchinh', 'Huy·∫øt h·ªçc')">Huy·∫øt h·ªçc <i class="fas fa-chevron-right"></i></div>
            <div class="sub-item" onclick="loadData('tb_chinh/Mi·ªÖn d·ªãch', 'üß´ MI·ªÑN D·ªäCH', 'tbchinh', 'Mi·ªÖn d·ªãch')">Mi·ªÖn d·ªãch <i class="fas fa-chevron-right"></i></div>
            <div class="sub-item" onclick="loadData('tb_chinh/Sinh h√≥a', '‚öóÔ∏è SINH H√ìA', 'tbchinh', 'Sinh h√≥a')">Sinh h√≥a <i class="fas fa-chevron-right"></i></div>
            <div class="sub-item" onclick="loadData('tb_chinh/Vi sinh', 'ü¶† VI SINH', 'tbchinh', 'Vi sinh')">Vi sinh <i class="fas fa-chevron-right"></i></div>
            <div class="sub-item" onclick="loadData('tb_chinh/SHPT', 'üß¨ SHPT', 'tbchinh', 'SHPT')">SHPT <i class="fas fa-chevron-right"></i></div>
        </div>

        <div class="menu-item active-purple" onclick="loadData('ds_tong_phu', 'üõ†Ô∏è T·ªîNG THI·∫æT B·ªä PH·ª§', 'dstongphu')">
            <i class="fas fa-toolbox"></i> <span>T·ªîNG THI·∫æT B·ªä PH·ª§</span>
        </div>

        <div class="menu-item active-blue" onclick="toggleSubmenu('sub_phu', this)">
            <i class="fas fa-tools"></i> <span>THI·∫æT B·ªä PH·ª§</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div id="sub_phu" class="submenu">
            <div class="sub-item" onclick="loadData('tb_phu/M√°y ly t√¢m', 'üîÑ M√ÅY LY T√ÇM', 'tbphu', 'M√°y ly t√¢m')">M√°y ly t√¢m <i class="fas fa-chevron-right"></i></div>
            <div class="sub-item" onclick="loadData('tb_phu/T·ªß l·∫°nh', '‚ùÑÔ∏è T·ª¶ L·∫†NH', 'tbphu', 'T·ªß l·∫°nh')">T·ªß l·∫°nh <i class="fas fa-chevron-right"></i></div>
            <div class="sub-item" onclick="loadData('tb_phu/T·ªß √¢m s√¢u', 'üßä T·ª¶ √ÇM S√ÇU', 'tbphu', 'T·ªß √¢m s√¢u')">T·ªß √¢m s√¢u <i class="fas fa-chevron-right"></i></div>
            <div class="sub-item" onclick="loadData('tb_phu/Nhi·ªát k·∫ø', 'üå°Ô∏è NHI·ªÜT K·∫æ', 'tbphu', 'Nhi·ªát k·∫ø')">Nhi·ªát k·∫ø HC <i class="fas fa-chevron-right"></i></div>
            <div class="sub-item" onclick="loadData('tb_phu/Nhi·ªát k·∫ø ph√≤ng', 'üè† NHI·ªÜT K·∫æ PH√íNG', 'tbphu', 'Nhi·ªát k·∫ø ph√≤ng')">Nhi·ªát k·∫ø ph√≤ng <i class="fas fa-chevron-right"></i></div>
            <div class="sub-item" onclick="loadData('tb_phu/T·ªß ATSH', 'üõ°Ô∏è T·ª¶ ATSH', 'tbphu', 'T·ªß ATSH')">T·ªß ATSH <i class="fas fa-chevron-right"></i></div>
            <div class="sub-item" onclick="loadData('tb_phu/Pipette', 'üß™ PIPETTE', 'tbphu', 'Pipette')">Pipette <i class="fas fa-chevron-right"></i></div>
            <div class="sub-item" onclick="loadData('tb_phu/N·ªìi h·∫•p', '‚ô®Ô∏è N·ªíI H·∫§P', 'tbphu', 'N·ªìi h·∫•p')">N·ªìi h·∫•p <i class="fas fa-chevron-right"></i></div>
            <div class="sub-item" onclick="loadData('tb_phu/T·ªß ·∫•m', 'üì¶ T·ª¶ ·∫§M', 'tbphu', 'T·ªß ·∫•m')">T·ªß ·∫•m <i class="fas fa-chevron-right"></i></div>
            <div class="sub-item" onclick="loadData('tb_phu/Kh√°c', '‚ûï THI·∫æT B·ªä KH√ÅC', 'tbphu', 'Kh√°c')">Kh√°c <i class="fas fa-plus-circle"></i></div>
        </div>

        <div class="nav-label">Ho·∫°t ƒë·ªông chuy√™n m√¥n</div>
        <div class="menu-item" style="color: #fbbf24;" onclick="loadData('ke_hoach/Goc', 'üìÖ SO·∫†N TH·∫¢O K·∫æ HO·∫†CH', 'kehoach')">
            <i class="fas fa-calendar-check"></i> <b>K·∫ø Ho·∫°ch</b>
        </div>
        <div id="archive_kh_list"></div>
        
        <div class="menu-item" style="color: #34d399;" onclick="loadData('kq_hieu_chuan/Goc', 'üìä SO·∫†N TH·∫¢O K·∫æT QU·∫¢', 'kqhc')">
            <i class="fas fa-chart-line"></i> <b>K·∫øt Qu·∫£ HC</b>
        </div>
        <div id="archive_kq_list"></div>
    </div>
</div>

<div class="main">
    <div class="header-card">
        <h1 id="title" style="margin:0; font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">H·ªá Th·ªëng Qu·∫£n L√Ω Khoa XN</h1>
        <p style="margin: 10px 0 0; opacity: 0.9; font-weight: 300;">B·ªánh vi·ªán Ung B∆∞·ªõu TP.HCM - C∆° s·ªü 2</p>
    </div>

    <div class="content-box">
        <div class="toolbar">
            <button class="btn btn-add" onclick="addRow()"><i class="fas fa-plus"></i> Th√™m D√≤ng</button>
            <button class="btn btn-excel" onclick="exportExcel()"><i class="fas fa-file-excel"></i> Xu·∫•t Excel</button>
            <button id="btn-snap-kh" class="btn btn-save" style="display:none;" onclick="saveSnapshot('ke_hoach', 'KH')"><i class="fas fa-calendar-check"></i> Ch·ªët K·∫ø Ho·∫°ch</button>
            <button id="btn-snap-kq" class="btn btn-save" style="display:none;" onclick="saveSnapshot('kq_hieu_chuan', 'KQ')"><i class="fas fa-check-double"></i> Ch·ªët K·∫øt Qu·∫£</button>
            
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="search" class="search-input" placeholder="T√¨m ki·∫øm trong d·ªØ li·ªáu..." oninput="render()">
            </div>
        </div>

        <div class="table-container">
            <table><thead id="thead"></thead><tbody id="tbody"></tbody></table>
        </div>
    </div>
</div>

<script>
let currentMode="", currentKey="", currentGroup="", currentData=[];

const GROUPS_CHINH = ["Huy·∫øt h·ªçc", "Mi·ªÖn d·ªãch", "Sinh h√≥a", "Vi sinh", "SHPT"];
const GROUPS_PHU = ["M√°y ly t√¢m", "T·ªß l·∫°nh", "T·ªß √¢m s√¢u", "Nhi·ªát k·∫ø", "Nhi·ªát k·∫ø ph√≤ng", "T·ªß ATSH", "Pipette", "N·ªìi h·∫•p", "T·ªß ·∫•m", "Kh√°c"];

const COLS = {
    dstong: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Model","Serial","V·ªã tr√≠","S·∫£n xu·∫•t","Cung ·ª©ng","Li√™n h·ªá","Ph·ª• tr√°ch"],
    tbchinh: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Model","Serial","V·ªã tr√≠","S·∫£n xu·∫•t","Cung ·ª©ng","Li√™n h·ªá","T√¨nh tr·∫°ng","Ph·ª• tr√°ch"],
    dstongphu: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Ch·ªßng lo·∫°i","Serial","Nh√† s·∫£n xu·∫•t","N∆∞·ªõc","Ng√†y l·∫Øp","V·ªã tr√≠","T√¨nh tr·∫°ng"],
    tbphu: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Ch·ªßng lo·∫°i","Serial","Nh√† s·∫£n xu·∫•t","N∆∞·ªõc","Ng√†y l·∫Øp","V·ªã tr√≠","T√¨nh tr·∫°ng"],
    kqhc: ["M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Model","Serial","Ng√†y hi·ªáu chu·∫©n","Ng√†y ti·∫øp theo","K·∫øt qu·∫£","ƒê∆°n v·ªã","Ghi ch√∫"],
    kehoach: ["M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Serial","Th·ªùi gian th·ª±c hi·ªán","N·ªôi dung y√™u c·∫ßu","Ti√™u ch√≠ ch·∫•p nh·∫≠n","Ghi ch√∫"]
};

function toggleSubmenu(id, element) {
    const sub = document.getElementById(id);
    const arrow = element.querySelector('.arrow');
    const allSubs = document.querySelectorAll('.submenu');
    const allArrows = document.querySelectorAll('.arrow');

    if(sub.style.display !== "block") {
        allSubs.forEach(s => s.style.display = "none");
        allArrows.forEach(a => a.classList.remove('rotated'));
        sub.style.display = "block";
        arrow.classList.add('rotated');
    } else {
        sub.style.display = "none";
        arrow.classList.remove('rotated');
    }
}

function loadData(key, title, mode, group = "") {
    currentKey = key; currentMode = mode; currentGroup = group;
    document.getElementById("title").innerText = title;
    
    document.getElementById("btn-snap-kh").style.display = (key === 'ke_hoach/Goc') ? "flex" : "none";
    document.getElementById("btn-snap-kq").style.display = (key === 'kq_hieu_chuan/Goc') ? "flex" : "none";

    window.dbOnValue(window.dbRef(window.db, window.dbPath + key), (snap) => {
        const val = snap.val();
        currentData = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
        render();
    });
}

function render() {
    const cols = COLS[currentMode] || [];
    const q = (document.getElementById("search")?.value || "").toLowerCase();
    const tbody = document.getElementById("tbody");
    document.getElementById("thead").innerHTML = `<tr><th style="width:50px">STT</th>${cols.map(c => `<th>${c}</th>`).join("")}<th style="width:50px">X√≥a</th></tr>`;
    tbody.innerHTML = "";
    
    let stt = 1;
    currentData.forEach((row, index) => {
        if (!row) return; 
        if(q && !Object.values(row).some(v => String(v).toLowerCase().includes(q))) return;
        
        const tr = document.createElement("tr");
        let html = `<td><span style="color:#94a3b8; font-weight:bold">${stt++}</span></td>`;
        cols.forEach(c => {
            const isReadonly = (c === "Nh√≥m" && (currentMode === 'tbchinh' || currentMode === 'tbphu')) ? 'contenteditable="false" style="background:#f8fafc; color:#64748b"' : 'contenteditable="true"';
            html += `<td ${isReadonly} onblur="updateCell(${index},'${c}',this.innerText)">${row[c]||""}</td>`;
        });
        html += `<td><i class="fas fa-trash-alt" style="color:#f87171; cursor:pointer" onclick="deleteRow(${index})"></i></td>`;
        tr.innerHTML = html;
        tbody.appendChild(tr);
    });
}

async function updateCell(index, col, val) {
    const newVal = val.trim();
    if (currentData[index][col] === newVal) return;
    currentData[index][col] = newVal;
    await safeSave(currentKey, currentData);

    if (currentMode === 'dstong') syncAll('dstong', 'tb_chinh', GROUPS_CHINH);
    if (currentMode === 'dstongphu') syncAll('dstongphu', 'tb_phu', GROUPS_PHU);
}

async function safeSave(key, data) {
    if (!key) return;
    const cleanData = data.filter(item => item !== null);
    await window.dbSet(window.dbRef(window.db, window.dbPath + key), cleanData);
}

async function syncAll(masterMode, folder, groups) {
    let buckets = {};
    groups.forEach(g => buckets[g] = []);

    currentData.forEach(item => {
        if (!item) return;
        const itemGrp = (item["Nh√≥m"] || "").trim();
        // Ki·ªÉm tra kh·ªõp nh√≥m ho·∫∑c ƒë∆∞a v√†o nh√≥m Kh√°c n·∫øu kh√¥ng kh·ªõp danh s√°ch
        let found = groups.find(g => g.toLowerCase() === itemGrp.toLowerCase());
        
        if (found) {
            let row = {};
            const subCols = COLS[masterMode === 'dstong' ? 'tbchinh' : 'tbphu'];
            subCols.forEach(c => row[c] = item[c] || "");
            row["Nh√≥m"] = found;
            buckets[found].push(row);
        }
    });

    for (const g of groups) {
        await safeSave(`${folder}/${g}`, buckets[g]);
    }
}

async function addRow() {
    let obj = {}; 
    COLS[currentMode].forEach(c => obj[c] = (c === "Nh√≥m" ? currentGroup : ""));
    currentData.push(obj);
    await safeSave(currentKey, currentData);
}

async function deleteRow(index) {
    if(!confirm("X√°c nh·∫≠n x√≥a d√≤ng n√†y?")) return;
    currentData.splice(index, 1);
    await safeSave(currentKey, currentData);
    if (currentMode === 'dstong') syncAll('dstong', 'tb_chinh', GROUPS_CHINH);
    if (currentMode === 'dstongphu') syncAll('dstongphu', 'tb_phu', GROUPS_PHU);
}

async function saveSnapshot(folder, prefix) {
    const d = new Date();
    const name = prompt("T√™n phi√™n b·∫£n l∆∞u:", `${prefix} - ${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`);
    if(!name) return;
    const dataCopy = JSON.parse(JSON.stringify(currentData.filter(i => i !== null)));
    await safeSave(`${folder}/Archives/${name}`, dataCopy);
}

function loadArchives() {
    window.dbOnValue(window.dbRef(window.db, window.dbPath + 'ke_hoach/Archives'), (snap) => renderArchives(snap.val(), 'archive_kh_list', 'ke_hoach', 'kehoach'));
    window.dbOnValue(window.dbRef(window.db, window.dbPath + 'kq_hieu_chuan/Archives'), (snap) => renderArchives(snap.val(), 'archive_kq_list', 'kq_hieu_chuan', 'kqhc'));
}

function renderArchives(data, id, folder, mode) {
    const div = document.getElementById(id); div.innerHTML = "";
    if(data) Object.keys(data).forEach(k => {
        const item = document.createElement("div"); item.className="sub-item";
        item.innerHTML = `<span style="flex-grow:1" onclick="loadData('${folder}/Archives/${k}','B·∫¢N L∆ØU: ${k}','${mode}')"><i class="fas fa-history"></i> ${k}</span>
                          <i class="fas fa-times" style="font-size:11px;cursor:pointer;color:#f87171" onclick="deleteArchive('${folder}','${k}')"></i>`;
        div.appendChild(item);
    });
}

async function deleteArchive(f, k) {
    if(confirm(`X√≥a b·∫£n l∆∞u ${k}?`)) await window.dbRemove(window.dbRef(window.db, window.dbPath + `${f}/Archives/${k}`));
}

function exportExcel() {
    const ws = XLSX.utils.json_to_sheet(currentData.filter(i => i !== null));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "D·ªØ li·ªáu");
    XLSX.writeFile(wb, `LabData_${new Date().getTime()}.xlsx`);
}

window.onload = () => { 
    loadArchives(); 
    loadData('ds_tong', 'üì¶ T·ªîNG THI·∫æT B·ªä CH√çNH', 'dstong'); 
};
</script>
</body>
</html>
