<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAB MANAGER - BV UNG B∆Ø·ªöU</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            databaseURL: "https://tbkxnub-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.dbPath = "users/-OiHXtd0s_Vjtd2VM2fN/name/";
        window.db = db; window.dbRef = ref; window.dbSet = set; 
        window.dbOnValue = onValue; window.dbRemove = remove; window.dbUpdate = update; window.dbGet = get;
    </script>

    <style>
        :root { --glass: rgba(255, 255, 255, 0.95); --primary: #0f172a; --accent: #3b82f6; --gradient: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); --sidebar-w: 280px; }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { margin: 0; background: #e2e8f0; display: flex; min-height: 100vh; color: #1e293b; }
        .sidebar { width: var(--sidebar-w); background: var(--primary); color: white; padding: 20px 0; display: flex; flex-direction: column; box-shadow: 4px 0 15px rgba(0,0,0,0.2); z-index: 100; user-select: none; }
        .logo-box { padding: 0 20px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo-box img { width: 70px; background: white; border-radius: 50%; padding: 5px; }
        .brand-name { display: block; font-size: 20px; font-weight: 800; margin-top: 10px; color: #60a5fa; }
        .menu-scroll { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .nav-label { font-size: 11px; color: #64748b; font-weight: 700; margin: 20px 0 10px 5px; text-transform: uppercase; letter-spacing: 1.5px; }
        .menu-item { padding: 12px 15px; border-radius: 10px; margin-bottom: 5px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 14px; transition: 0.3s; }
        .menu-item:hover { background: rgba(255,255,255,0.1); }
        .active-orange { background: #ea580c !important; }
        .active-blue { background: #2563eb !important; font-weight: bold; }
        .active-purple { background: #9333ea !important; }
        .submenu { display: none; padding-left: 15px; margin: 5px 0 10px; border-left: 1px solid #334155; }
        .sub-item { padding: 8px 12px; font-size: 13px; color: #94a3b8; cursor: pointer; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .sub-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .main { flex-grow: 1; padding: 25px; max-width: calc(100% - var(--sidebar-w)); }
        .header-card { background: var(--gradient); padding: 30px; border-radius: 20px; color: white; margin-bottom: 25px; user-select: none; }
        .content-box { background: var(--glass); border-radius: 20px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; user-select: none; }
        .btn { padding: 10px 15px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; display: flex; align-items: center; gap: 8px; color: white; transition: 0.2s; font-size: 13px; }
        .btn-add { background: #0f172a; }
        .btn-excel { background: #10b981; }
        .btn-sync { background: #ef4444; }
        .btn-save { background: #f59e0b; }
        .search-container { position: relative; flex-grow: 1; min-width: 200px; }
        .search-container i { position: absolute; left: 15px; top: 12px; color: #94a3b8; }
        .search-input { width: 100%; padding: 10px 10px 10px 40px; border-radius: 12px; border: 1px solid #e2e8f0; outline: none; }
        .table-container { overflow: auto; max-height: 60vh; border-radius: 12px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 12px; table-layout: auto; }
        th { background: #f8fafc; padding: 12px; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #e2e8f0; white-space: nowrap; user-select: none; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; text-align: center; min-width: 80px; position: relative; white-space: pre-wrap; outline: none !important; transition: 0.1s; cursor: cell; }
        
        td.cell-selected { box-shadow: inset 0 0 0 2px #3b82f6 !important; background: #eff6ff !important; z-index: 5; }

        tr.returned { opacity: 0.4; filter: grayscale(0.8); background: #fee2e2 !important; }
        .return-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #dc2626; font-weight: 900; font-size: 14px; pointer-events: none; z-index: 10; display: none; text-transform: uppercase; }
        tr.returned .return-overlay { display: block; }
        .arrow { font-size: 10px; transition: 0.3s; margin-left: auto; }
        .rotated { transform: rotate(90deg); }
    </style>
</head>

<body>

<div class="sidebar">
    <div class="logo-box"><img src="https://bvub.vn/wp-content/uploads/2021/05/logo-ub.png" alt="Logo"><span class="brand-name">LAB MANAGER</span></div>
    <div class="menu-scroll">
        <div class="nav-label">H·ªá th·ªëng danh m·ª•c</div>
        <div class="menu-item active-orange" onclick="loadData('ds_tong', 'üì¶ T·ªîNG THI·∫æT B·ªä CH√çNH', 'dstong')"><i class="fas fa-layer-group"></i> <span>T·ªîNG THI·∫æT B·ªä CH√çNH</span></div>
        <div class="menu-item active-blue" onclick="toggleSubmenu('sub_chinh', this)"><i class="fas fa-microscope"></i> <span>THI·∫æT B·ªä CH√çNH</span> <span class="arrow">‚ñ∂</span></div>
        <div id="sub_chinh" class="submenu">
            <div class="sub-item" onclick="loadData('tb_chinh/Huy·∫øt h·ªçc', 'ü©∏ HUY·∫æT H·ªåC', 'tbchinh', 'Huy·∫øt h·ªçc')">Huy·∫øt h·ªçc</div>
            <div class="sub-item" onclick="loadData('tb_chinh/Mi·ªÖn d·ªãch', 'üß´ MI·ªÑN D·ªäCH', 'tbchinh', 'Mi·ªÖn d·ªãch')">Mi·ªÖn d·ªãch</div>
            <div class="sub-item" onclick="loadData('tb_chinh/Sinh h√≥a', '‚öóÔ∏è SINH H√ìA', 'tbchinh', 'Sinh h√≥a')">Sinh h√≥a</div>
            <div class="sub-item" onclick="loadData('tb_chinh/Vi sinh', 'ü¶† VI SINH', 'tbchinh', 'Vi sinh')">Vi sinh</div>
            <div class="sub-item" onclick="loadData('tb_chinh/SHPT', 'üß¨ SHPT', 'tbchinh', 'SHPT')">SHPT</div>
        </div>
        
        <div class="menu-item active-purple" onclick="loadData('ds_tong_phu', 'üõ†Ô∏è T·ªîNG THI·∫æT B·ªä PH·ª§', 'dstongphu')"><i class="fas fa-toolbox"></i> <span>T·ªîNG THI·∫æT B·ªä PH·ª§</span></div>
        <div class="menu-item active-blue" onclick="toggleSubmenu('sub_phu', this)"><i class="fas fa-tools"></i> <span>THI·∫æT B·ªä PH·ª§</span> <span class="arrow">‚ñ∂</span></div>
        <div id="sub_phu" class="submenu">
            <div class="sub-item" onclick="loadData('tb_phu/M√°y ly t√¢m', 'üîÑ M√ÅY LY T√ÇM', 'tbphu', 'M√°y ly t√¢m')">M√°y ly t√¢m</div>
            <div class="sub-item" onclick="loadData('tb_phu/T·ªß l·∫°nh', '‚ùÑÔ∏è T·ª¶ L·∫†NH', 'tbphu', 'T·ªß l·∫°nh')">T·ªß l·∫°nh</div>
            <div class="sub-item" onclick="loadData('tb_phu/T·ªß √¢m s√¢u', 'üßä T·ª¶ √ÇM S√ÇU', 'tbphu', 'T·ªß √¢m s√¢u')">T·ªß √¢m s√¢u</div>
            <div class="sub-item" onclick="loadData('tb_phu/Nhi·ªát k·∫ø', 'üå°Ô∏è NHI·ªÜT K·∫æ HC', 'tbphu', 'Nhi·ªát k·∫ø')">Nhi·ªát k·∫ø HC</div>
            <div class="sub-item" onclick="loadData('tb_phu/Pipette', 'üß™ PIPETTE', 'tbphu', 'Pipette')">Pipette</div>
            <div class="sub-item" onclick="loadData('tb_phu/C√¢n ƒëi·ªán t·ª≠', '‚öñÔ∏è C√ÇN ƒêI·ªÜN T·ª¨', 'tbphu', 'C√¢n ƒëi·ªán t·ª≠')">C√¢n ƒëi·ªán t·ª≠</div>
            <div class="sub-item" onclick="loadData('tb_phu/M√°y c·∫•t n∆∞·ªõc', 'üíß M√ÅY C·∫§T N∆Ø·ªöC', 'tbphu', 'M√°y c·∫•t n∆∞·ªõc')">M√°y c·∫•t n∆∞·ªõc</div>
            <div class="sub-item" onclick="loadData('tb_phu/B·ªÉ c√°ch th·ªßy', '‚ô®Ô∏è B·ªÇ C√ÅCH TH·ª¶Y', 'tbphu', 'B·ªÉ c√°ch th·ªßy')">B·ªÉ c√°ch th·ªßy</div>
            <div class="sub-item" onclick="loadData('tb_phu/K√≠nh hi·ªÉn vi', 'üî¨ K√çNH HI·ªÇN VI', 'tbphu', 'K√≠nh hi·ªÉn vi')">K√≠nh hi·ªÉn vi</div>
            <div class="sub-item" onclick="loadData('tb_phu/Kh√°c', '‚ûï THI·∫æT B·ªä KH√ÅC', 'tbphu', 'Kh√°c')">Kh√°c</div>
        </div>

        <div class="menu-item" style="background: #059669;" onclick="loadData('tb_ngoai', 'üöõ THI·∫æT B·ªä NGO√ÄI D·ª∞ √ÅN', 'tbngoai')"><i class="fas fa-truck-loading"></i> <span>TB NGO√ÄI D·ª∞ √ÅN</span></div>

        <div class="nav-label">Ho·∫°t ƒë·ªông chuy√™n m√¥n</div>
        <div class="menu-item" style="color: #fbbf24;" onclick="loadData('ke_hoach/Goc', 'üìÖ K·∫æ HO·∫†CH G·ªêC', 'kehoach')"><i class="fas fa-calendar-check"></i> <b>K·∫ø Ho·∫°ch G·ªëc</b></div>
        <div id="archive_kh_list"></div>
        <div class="menu-item" style="color: #34d399;" onclick="loadData('kq_hieu_chuan/Goc', 'üìä K·∫æT QU·∫¢ G·ªêC', 'kqhc')"><i class="fas fa-chart-line"></i> <b>K·∫øt Qu·∫£ G·ªëc</b></div>
        <div id="archive_kq_list"></div>
    </div>
</div>

<div class="main">
    <div class="header-card"><h1 id="title" style="margin:0;">H·ªá Th·ªëng Qu·∫£n L√Ω Khoa XN</h1><p style="margin: 10px 0 0; opacity: 0.9;">B·ªánh vi·ªán Ung B∆∞·ªõu TP.HCM - C∆° s·ªü 2</p></div>
    <div class="content-box">
        <div class="toolbar">
            <button class="btn btn-add" onclick="addRowAtPosition()"><i class="fas fa-plus"></i> Th√™m D√≤ng</button>
            <button class="btn btn-excel" onclick="exportExcel()"><i class="fas fa-file-excel"></i> Xu·∫•t Excel</button>
            <button id="btn-sync" class="btn btn-sync" onclick="manualSync()"><i class="fas fa-sync-alt"></i> L√ÄM M·ªöI DANH M·ª§C</button>
            <button id="btn-snap-kh" class="btn btn-save" style="display:none;" onclick="saveSnapshot('ke_hoach', 'KH')"><i class="fas fa-calendar-check"></i> Ch·ªët K·∫ø Ho·∫°ch</button>
            <button id="btn-snap-kq" class="btn btn-save" style="display:none;" onclick="saveSnapshot('kq_hieu_chuan', 'KQ')"><i class="fas fa-check-double"></i> Ch·ªët K·∫øt Qu·∫£</button>
            <div class="search-container"><i class="fas fa-search"></i><input type="text" id="search" class="search-input" placeholder="T√¨m ki·∫øm..." oninput="render()"></div>
        </div>
        <div class="table-container">
            <table>
                <thead id="thead"></thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
        <p style="font-size: 11px; color: #64748b; margin-top: 10px;">* HD: Click 1 l·∫ßn (Ch·ªçn √¥ ƒë·ªÉ Ctrl+V), Click ƒë√∫p (S·ª≠a ch·ªØ). M·∫∑c ƒë·ªãnh: M·ªõi 100%.</p>
    </div>
</div>

<script>
let currentMode="", currentKey="", currentGroup="", currentData=[];
let selectedRowIndex = -1, selectedColIndex = -1, isSyncing = false;
const MANAGER_DEFAULT = "Tr∆∞∆°ng C√¥ng H·∫≠u (0934187801)";
const STATUS_DEFAULT = "M·ªõi 100%";

const COLS = {
    dstong: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Model","Serial","V·ªã tr√≠","S·∫£n xu·∫•t","Cung ·ª©ng","Li√™n h·ªá","Ph·ª• tr√°ch"],
    tbchinh: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Model","Serial","V·ªã tr√≠","S·∫£n xu·∫•t","Cung ·ª©ng","Li√™n h·ªá","T√¨nh tr·∫°ng","Ph·ª• tr√°ch"],
    dstongphu: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Ch·ªßng lo·∫°i","Serial","Nh√† s·∫£n xu·∫•t","N∆∞·ªõc","Ng√†y l·∫Øp","V·ªã tr√≠","T√¨nh tr·∫°ng"],
    tbphu: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Ch·ªßng lo·∫°i","Serial","Nh√† s·∫£n xu·∫•t","N∆∞·ªõc","Ng√†y l·∫Øp","V·ªã tr√≠","T√¨nh tr·∫°ng"],
    tbngoai: ["M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Model","Serial","V·ªã tr√≠","S·∫£n xu·∫•t","Cung ·ª©ng","Li√™n h·ªá","T√¨nh tr·∫°ng","Ph·ª• tr√°ch"],
    kqhc: ["M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Model","Serial","Ng√†y hi·ªáu chu·∫©n","Ng√†y ti·∫øp theo","K·∫øt qu·∫£","ƒê∆°n v·ªã","Ghi ch√∫"],
    kehoach: ["M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Serial","Th·ªùi gian th·ª±c hi·ªán","N·ªôi dung y√™u c·∫ßu","Ti√™u ch√≠ ch·∫•p nh·∫≠n","Ghi ch√∫"]
};

function toggleSubmenu(id, element) {
    const sub = document.getElementById(id); sub.style.display = sub.style.display === "block" ? "none" : "block";
    element.querySelector('.arrow').classList.toggle('rotated');
}

function loadData(key, title, mode, group = "") {
    currentKey = key; currentMode = mode; currentGroup = group; 
    selectedRowIndex = -1; selectedColIndex = -1;
    document.getElementById("title").innerText = title;
    document.getElementById("btn-sync").style.display = (mode === 'dstong' || mode === 'dstongphu') ? "flex" : "none";
    document.getElementById("btn-snap-kh").style.display = (key === 'ke_hoach/Goc') ? "flex" : "none";
    document.getElementById("btn-snap-kq").style.display = (key === 'kq_hieu_chuan/Goc') ? "flex" : "none";

    window.dbOnValue(window.dbRef(window.db, window.dbPath + key), (snap) => {
        if (isSyncing) return;
        const val = snap.val(); 
        currentData = val ? (Array.isArray(val) ? val.filter(i => i !== null) : Object.values(val).filter(i => i !== null)) : [];
        render();
    });
}

function render() {
    const cols = COLS[currentMode] || [];
    const q = (document.getElementById("search")?.value || "").toLowerCase();
    const tbody = document.getElementById("tbody");
    
    document.getElementById("thead").innerHTML = `<tr><th style="width:50px">STT</th>${cols.map(c => `<th>${c}</th>`).join("")}${currentMode==='tbngoai'?'<th style="width:50px">Tr·∫£</th>':''}<th style="width:50px">X√≥a</th></tr>`;
    tbody.innerHTML = "";
    
    currentData.forEach((row, rIdx) => {
        if (!row) return; 
        if(q && !Object.values(row).some(v => String(v).toLowerCase().includes(q))) return;

        const tr = document.createElement("tr");
        if (row._returned) tr.className = "returned";

        let html = `<td>${rIdx+1}<div class="return-overlay">ƒê√É TR·∫¢ M√ÅY</div></td>`;
        
        cols.forEach((c, cIdx) => {
            html += `<td 
                contenteditable="false" 
                class="${(rIdx === selectedRowIndex && cIdx === selectedColIndex) ? 'cell-selected' : ''}"
                onmousedown="selectCell(${rIdx}, ${cIdx}, this)"
                ondblclick="this.contentEditable=true; this.focus()"
                onblur="this.contentEditable=false; updateCell(${rIdx},'${c}',this.innerText)"
                >${row[c] || ""}</td>`;
        });
        
        if (currentMode === 'tbngoai') {
            html += `<td><i class="fas ${row._returned?'fa-eye-slash':'fa-eye'}" style="color:#3b82f6; cursor:pointer" onclick="toggleReturn(${rIdx})"></i></td>`;
        }
        html += `<td><i class="fas fa-trash-alt" style="color:#f87171; cursor:pointer" onclick="deleteRow(${rIdx})"></i></td>`;
        tr.innerHTML = html;
        tbody.appendChild(tr);
    });
}

function selectCell(rIdx, cIdx, el) {
    selectedRowIndex = rIdx; selectedColIndex = cIdx;
    document.querySelectorAll('td').forEach(td => td.classList.remove('cell-selected'));
    el.classList.add('cell-selected');
}

// H√ÄM QUAN TR·ªåNG: S·ª≠a logic ƒë·ªÉ lu√¥n ∆∞u ti√™n "M·ªõi 100%"
function formatStatus(val) {
    if (!val) return STATUS_DEFAULT;
    let clean = val.toString().trim();
    if (clean === "" || clean === "1" || clean === "1%") return STATUS_DEFAULT; 
    if (clean === "100" || clean === "100%" || clean.toLowerCase() === "m·ªõi 100%") return STATUS_DEFAULT;
    if (!isNaN(clean)) return clean + "%";
    return clean;
}

document.addEventListener('paste', (e) => {
    if (selectedRowIndex !== -1) {
        const active = document.activeElement;
        if (active.tagName !== 'TD' || active.contentEditable === 'false') {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text/plain');
            handleDataPaste(text);
        }
    }
});

async function handleDataPaste(text) {
    if (!text || selectedRowIndex === -1) return;
    const rows = text.split(/\r?\n/).filter(line => line.trim().length > 0);
    const colsList = COLS[currentMode];

    rows.forEach((rowText, rOffset) => {
        let targetRowIdx = selectedRowIndex + rOffset;
        if (targetRowIdx >= currentData.length) {
            let newObj = {};
            colsList.forEach(c => {
                newObj[c] = (c === "Nh√≥m") ? currentGroup : (c === "Ph·ª• tr√°ch" ? MANAGER_DEFAULT : (c === "T√¨nh tr·∫°ng" ? STATUS_DEFAULT : ""));
            });
            currentData.push(newObj);
        }
        const cells = rowText.split('\t');
        cells.forEach((val, cOffset) => {
            let targetColIdx = selectedColIndex + cOffset;
            if (targetColIdx < colsList.length) {
                let colName = colsList[targetColIdx];
                if (!(colName === "Nh√≥m" && (currentMode === 'tbchinh' || currentMode === 'tbphu'))) {
                    let finalVal = val.trim().replace(/^"|"$/g, ''); 
                    if (colName === "T√¨nh tr·∫°ng") finalVal = formatStatus(finalVal);
                    currentData[targetRowIdx][colName] = finalVal;
                }
            }
        });
    });
    await safeSave(currentKey, currentData);
    render();
}

document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'c' && selectedRowIndex !== -1 && document.activeElement.tagName !== 'TD') {
        const colName = COLS[currentMode][selectedColIndex];
        const value = currentData[selectedRowIndex][colName] || "";
        navigator.clipboard.writeText(value);
    }
    if (e.key === 'Enter' && selectedRowIndex !== -1) {
        const selectedEl = document.querySelector('.cell-selected');
        if (selectedEl && selectedEl.contentEditable !== 'true') {
            e.preventDefault();
            selectedEl.contentEditable = 'true';
            selectedEl.focus();
        }
    }
});

async function linkDataByMaTB(index, maTB) {
    if (!maTB) return;
    const paths = ["ds_tong", "ds_tong_phu"];
    for (const p of paths) {
        const snap = await window.dbGet(window.dbRef(window.db, window.dbPath + p));
        const allData = snap.val() || [];
        const found = Object.values(allData).find(item => item && item["M√£ thi·∫øt b·ªã"] === maTB);
        if (found) {
            currentData[index]["T√™n thi·∫øt b·ªã"] = found["T√™n thi·∫øt b·ªã"] || "";
            currentData[index]["Model"] = found["Model"] || found["Ch·ªßng lo·∫°i"] || "";
            currentData[index]["Serial"] = found["Serial"] || "";
            currentData[index]["V·ªã tr√≠"] = found["V·ªã tr√≠"] || "";
            currentData[index]["S·∫£n xu·∫•t"] = found["S·∫£n xu·∫•t"] || found["Nh√† s·∫£n xu·∫•t"] || "";
            currentData[index]["Cung ·ª©ng"] = found["Cung ·ª©ng"] || "";
            currentData[index]["Li√™n h·ªá"] = found["Li√™n h·ªá"] || "";
            currentData[index]["T√¨nh tr·∫°ng"] = found["T√¨nh tr·∫°ng"] || STATUS_DEFAULT;
            currentData[index]["Ph·ª• tr√°ch"] = found["Ph·ª• tr√°ch"] || MANAGER_DEFAULT;
            break;
        }
    }
}

async function updateCell(index, col, val) {
    let newVal = val.trim();
    if (col === "T√¨nh tr·∫°ng") newVal = formatStatus(newVal);
    if (col === "Ph·ª• tr√°ch" && newVal === "") newVal = MANAGER_DEFAULT;
    
    currentData[index][col] = newVal; 
    if (currentMode === 'tbngoai' && col === "M√£ thi·∫øt b·ªã") await linkDataByMaTB(index, newVal);
    await safeSave(currentKey, currentData);
    if (col === "T√¨nh tr·∫°ng" || col === "M√£ thi·∫øt b·ªã") render();
}

async function toggleReturn(index) {
    currentData[index]._returned = !currentData[index]._returned;
    await safeSave(currentKey, currentData);
    render();
}

async function safeSave(key, data) {
    const cleanData = data.filter(item => item !== null);
    await window.dbSet(window.dbRef(window.db, window.dbPath + key), cleanData);
}

async function addRowAtPosition() {
    let obj = {}; 
    COLS[currentMode].forEach(c => {
        obj[c] = (c === "Nh√≥m") ? currentGroup : (c === "Ph·ª• tr√°ch" ? MANAGER_DEFAULT : (c === "T√¨nh tr·∫°ng" ? STATUS_DEFAULT : ""));
    });
    if (selectedRowIndex !== -1) currentData.splice(selectedRowIndex + 1, 0, obj);
    else currentData.push(obj);
    await safeSave(currentKey, currentData);
}

async function deleteRow(index) {
    if(!confirm("X√°c nh·∫≠n x√≥a?")) return;
    currentData.splice(index, 1); selectedRowIndex = -1; await safeSave(currentKey, currentData);
}

async function manualSync() {
    if(!confirm("ƒê·ªìng b·ªô d·ªØ li·ªáu?")) return;
    isSyncing = true;
    const btn = document.getElementById("btn-sync"); btn.disabled = true; btn.innerText = "ƒêang x·ª≠ l√Ω...";
    try {
        const folder = currentMode === 'dstong' ? 'tb_chinh' : 'tb_phu';
        const groups = currentMode === 'dstong' 
            ? ["Huy·∫øt h·ªçc", "Mi·ªÖn d·ªãch", "Sinh h√≥a", "Vi sinh", "SHPT"] 
            : ["M√°y ly t√¢m", "T·ªß l·∫°nh", "T·ªß √¢m s√¢u", "Nhi·ªát k·∫ø", "Pipette", "C√¢n ƒëi·ªán t·ª≠", "M√°y c·∫•t n∆∞·ªõc", "B·ªÉ c√°ch th·ªßy", "K√≠nh hi·ªÉn vi", "Kh√°c"];
            
        for (const g of groups) {
            const snap = await window.dbGet(window.dbRef(window.db, window.dbPath + `${folder}/${g}`));
            let childData = snap.val() || [];
            if (!Array.isArray(childData)) childData = Object.values(childData);
            let masterItems = currentData.filter(item => item && (item["Nh√≥m"] || "").trim().toLowerCase() === g.toLowerCase());
            let newChildData = masterItems.map(mItem => {
                const maTB = mItem["M√£ thi·∫øt b·ªã"];
                const existingItem = childData.find(cItem => cItem && cItem["M√£ thi·∫øt b·ªã"] === maTB);
                if (existingItem) return { ...existingItem, ...mItem, Nh√≥m: g };
                return { ...mItem, Nh√≥m: g };
            });
            await safeSave(`${folder}/${g}`, newChildData);
        }
        alert("ƒê·ªìng b·ªô th√†nh c√¥ng!");
    } catch (e) { alert("L·ªói: " + e.message); }
    finally { isSyncing = false; btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync-alt"></i> L√ÄM M·ªöI DANH M·ª§C'; render(); }
}

function exportExcel() {
    const ws = XLSX.utils.json_to_sheet(currentData.filter(i => i !== null));
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "D·ªØ li·ªáu");
    XLSX.writeFile(wb, `LabData_${new Date().getTime()}.xlsx`);
}

function initArchives() {
    window.dbOnValue(window.dbRef(window.db, window.dbPath + 'ke_hoach/Archives'), (snap) => renderArchives(snap.val(), 'archive_kh_list', 'ke_hoach', 'kehoach'));
    window.dbOnValue(window.dbRef(window.db, window.dbPath + 'kq_hieu_chuan/Archives'), (snap) => renderArchives(snap.val(), 'archive_kq_list', 'kq_hieu_chuan', 'kqhc'));
}

function renderArchives(data, id, folder, mode) {
    const div = document.getElementById(id); div.innerHTML = "";
    if(data) Object.keys(data).forEach(k => {
        const item = document.createElement("div"); item.className="sub-item";
        item.innerHTML = `<span style="flex-grow:1" onclick="loadData('${folder}/Archives/${k}','B·∫¢N L∆ØU: ${k}','${mode}')"><i class="fas fa-file-alt"></i> ${k}</span>
            <div style="display:flex; gap:8px;"><i class="fas fa-edit" style="color:#fbbf24; cursor:pointer" onclick="renameArchive('${folder}','${k}')"></i>
            <i class="fas fa-times" style="color:#f87171; cursor:pointer" onclick="deleteArchive('${folder}','${k}')"></i></div>`;
        div.appendChild(item);
    });
}

async function deleteArchive(f, k) { if(confirm(`X√≥a?`)) await window.dbRemove(window.dbRef(window.db, window.dbPath + `${f}/Archives/${k}`)); }
async function renameArchive(f, oldK) {
    const newK = prompt("T√™n m·ªõi:", oldK); if(!newK || newK === oldK) return;
    const oldRef = window.dbRef(window.db, window.dbPath + `${f}/Archives/${oldK}`);
    window.dbOnValue(oldRef, async (snap) => { await window.dbSet(window.dbRef(window.db, window.dbPath + `${f}/Archives/${newK}`), snap.val()); await window.dbRemove(oldRef); }, { onlyOnce: true });
}

window.onload = () => { initArchives(); loadData('ds_tong', 'üì¶ T·ªîNG THI·∫æT B·ªä CH√çNH', 'dstong'); };
</script>
</body>
</html>
