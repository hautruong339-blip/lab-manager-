<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAB MANAGER - BV UNG B∆Ø·ªöU</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            databaseURL: "https://tbkxnub-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.dbPath = "users/-OiHXtd0s_Vjtd2VM2fN/name/";
        window.db = db; window.dbRef = ref; window.dbSet = set; 
        window.dbOnValue = onValue; window.dbRemove = remove; window.dbUpdate = update;
    </script>

    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.95);
            --primary: #0f172a;
            --accent: #3b82f6;
            --gradient: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            --sidebar-w: 280px;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { margin: 0; background: #e2e8f0; display: flex; min-height: 100vh; color: #1e293b; }

        .sidebar { width: var(--sidebar-w); background: var(--primary); color: white; padding: 20px 0; display: flex; flex-direction: column; box-shadow: 4px 0 15px rgba(0,0,0,0.2); z-index: 100; }
        .logo-box { padding: 0 20px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo-box img { width: 70px; background: white; border-radius: 50%; padding: 5px; }
        .brand-name { display: block; font-size: 20px; font-weight: 800; margin-top: 10px; color: #60a5fa; }

        .menu-scroll { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .nav-label { font-size: 11px; color: #64748b; font-weight: 700; margin: 20px 0 10px 5px; text-transform: uppercase; letter-spacing: 1.5px; }

        .menu-item { padding: 12px 15px; border-radius: 10px; margin-bottom: 5px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 14px; transition: 0.3s; }
        .menu-item:hover { background: rgba(255,255,255,0.1); }
        .active-orange { background: #ea580c !important; }
        .active-blue { background: #2563eb !important; }
        .active-purple { background: #9333ea !important; }

        .submenu { display: none; padding-left: 15px; margin: 5px 0 10px; border-left: 1px solid #334155; }
        .sub-item { padding: 8px 12px; font-size: 13px; color: #94a3b8; cursor: pointer; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .sub-item:hover { color: white; background: rgba(255,255,255,0.05); }

        .main { flex-grow: 1; padding: 25px; max-width: calc(100% - var(--sidebar-w)); }
        .header-card { background: var(--gradient); padding: 30px; border-radius: 20px; color: white; margin-bottom: 25px; }
        .content-box { background: var(--glass); border-radius: 20px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }

        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 10px 15px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; display: flex; align-items: center; gap: 8px; color: white; transition: 0.2s; font-size: 13px; }
        .btn-add { background: #0f172a; }
        .btn-excel { background: #10b981; }
        .btn-sync { background: #ef4444; }
        .btn-save { background: #f59e0b; }

        .search-container { position: relative; flex-grow: 1; min-width: 200px; }
        .search-container i { position: absolute; left: 15px; top: 12px; color: #94a3b8; }
        .search-input { width: 100%; padding: 10px 10px 10px 40px; border-radius: 12px; border: 1px solid #e2e8f0; outline: none; }

        .table-container { overflow: auto; max-height: 60vh; border-radius: 12px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 12px; }
        th { background: #f8fafc; padding: 12px; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        tr.selected td { background-color: #e0f2fe !important; }

        [contenteditable="true"]:focus { outline: 2px solid #3b82f6; background: #fff; }
        .arrow { font-size: 10px; transition: 0.3s; margin-left: auto; }
        .rotated { transform: rotate(90deg); }
    </style>
</head>

<body>

<div class="sidebar">
    <div class="logo-box">
        <img src="https://bvub.vn/wp-content/uploads/2021/05/logo-ub.png" alt="Logo">
        <span class="brand-name">LAB MANAGER</span>
    </div>

    <div class="menu-scroll">
        <div class="nav-label">H·ªá th·ªëng danh m·ª•c</div>
        <div class="menu-item active-orange" onclick="loadData('ds_tong', 'üì¶ T·ªîNG THI·∫æT B·ªä CH√çNH', 'dstong')">
            <i class="fas fa-layer-group"></i> <span>T·ªîNG THI·∫æT B·ªä CH√çNH</span>
        </div>
        <div class="menu-item active-blue" onclick="toggleSubmenu('sub_chinh', this)">
            <i class="fas fa-microscope"></i> <span>THI·∫æT B·ªä CH√çNH</span> <span class="arrow">‚ñ∂</span>
        </div>
        <div id="sub_chinh" class="submenu">
            <div class="sub-item" onclick="loadData('tb_chinh/Huy·∫øt h·ªçc', 'ü©∏ HUY·∫æT H·ªåC', 'tbchinh', 'Huy·∫øt h·ªçc')">Huy·∫øt h·ªçc</div>
            <div class="sub-item" onclick="loadData('tb_chinh/Mi·ªÖn d·ªãch', 'üß´ MI·ªÑN D·ªäCH', 'tbchinh', 'Mi·ªÖn d·ªãch')">Mi·ªÖn d·ªãch</div>
            <div class="sub-item" onclick="loadData('tb_chinh/Sinh h√≥a', '‚öóÔ∏è SINH H√ìA', 'tbchinh', 'Sinh h√≥a')">Sinh h√≥a</div>
            <div class="sub-item" onclick="loadData('tb_chinh/Vi sinh', 'ü¶† VI SINH', 'tbchinh', 'Vi sinh')">Vi sinh</div>
            <div class="sub-item" onclick="loadData('tb_chinh/SHPT', 'üß¨ SHPT', 'tbchinh', 'SHPT')">SHPT</div>
        </div>

        <div class="menu-item active-purple" onclick="loadData('ds_tong_phu', 'üõ†Ô∏è T·ªîNG THI·∫æT B·ªä PH·ª§', 'dstongphu')">
            <i class="fas fa-toolbox"></i> <span>T·ªîNG THI·∫æT B·ªä PH·ª§</span>
        </div>
        <div class="menu-item active-blue" onclick="toggleSubmenu('sub_phu', this)">
            <i class="fas fa-tools"></i> <span>THI·∫æT B·ªä PH·ª§</span> <span class="arrow">‚ñ∂</span>
        </div>
        <div id="sub_phu" class="submenu">
            <div class="sub-item" onclick="loadData('tb_phu/M√°y ly t√¢m', 'üîÑ M√ÅY LY T√ÇM', 'tbphu', 'M√°y ly t√¢m')">M√°y ly t√¢m</div>
            <div class="sub-item" onclick="loadData('tb_phu/T·ªß l·∫°nh', '‚ùÑÔ∏è T·ª¶ L·∫†NH', 'tbphu', 'T·ªß l·∫°nh')">T·ªß l·∫°nh</div>
            <div class="sub-item" onclick="loadData('tb_phu/T·ªß √¢m s√¢u', 'üßä T·ª¶ √ÇM S√ÇU', 'tbphu', 'T·ªß √¢m s√¢u')">T·ªß √¢m s√¢u</div>
            <div class="sub-item" onclick="loadData('tb_phu/Nhi·ªát k·∫ø', 'üå°Ô∏è NHI·ªÜT K·∫æ HC', 'tbphu', 'Nhi·ªát k·∫ø')">Nhi·ªát k·∫ø HC</div>
            <div class="sub-item" onclick="loadData('tb_phu/Nhi·ªát k·∫ø ph√≤ng', 'üè† NHI·ªÜT K·∫æ PH√íNG', 'tbphu', 'Nhi·ªát k·∫ø ph√≤ng')">Nhi·ªát k·∫ø ph√≤ng</div>
            <div class="sub-item" onclick="loadData('tb_phu/T·ªß ATSH', 'üõ°Ô∏è T·ª¶ ATSH', 'tbphu', 'T·ªß ATSH')">T·ªß ATSH</div>
            <div class="sub-item" onclick="loadData('tb_phu/Pipette', 'üß™ PIPETTE', 'tbphu', 'Pipette')">Pipette</div>
            <div class="sub-item" onclick="loadData('tb_phu/N·ªìi h·∫•p', '‚ô®Ô∏è N·ªíI H·∫§P', 'tbphu', 'N·ªìi h·∫•p')">N·ªìi h·∫•p</div>
            <div class="sub-item" onclick="loadData('tb_phu/T·ªß ·∫•m', 'üì¶ T·ª¶ ·∫§M', 'tbphu', 'T·ªß ·∫•m')">T·ªß ·∫•m</div>
            <div class="sub-item" onclick="loadData('tb_phu/Kh√°c', '‚ûï THI·∫æT B·ªä KH√ÅC', 'tbphu', 'Kh√°c')">Kh√°c</div>
        </div>

        <div class="nav-label">Ho·∫°t ƒë·ªông chuy√™n m√¥n</div>
        <div class="menu-item" style="color: #fbbf24;" onclick="loadData('ke_hoach/Goc', 'üìÖ K·∫æ HO·∫†CH G·ªêC', 'kehoach')">
            <i class="fas fa-calendar-check"></i> <b>K·∫ø Ho·∫°ch G·ªëc</b>
        </div>
        <div id="archive_kh_list"></div>
        <div class="menu-item" style="color: #34d399;" onclick="loadData('kq_hieu_chuan/Goc', 'üìä K·∫æT QU·∫¢ G·ªêC', 'kqhc')">
            <i class="fas fa-chart-line"></i> <b>K·∫øt Qu·∫£ G·ªëc</b>
        </div>
        <div id="archive_kq_list"></div>
    </div>
</div>

<div class="main">
    <div class="header-card">
        <h1 id="title" style="margin:0;">H·ªá Th·ªëng Qu·∫£n L√Ω Khoa XN</h1>
        <p style="margin: 10px 0 0; opacity: 0.9;">B·ªánh vi·ªán Ung B∆∞·ªõu TP.HCM - C∆° s·ªü 2</p>
    </div>

    <div class="content-box">
        <div class="toolbar">
            <button class="btn btn-add" onclick="addRowAtPosition()"><i class="fas fa-plus"></i> Th√™m D√≤ng</button>
            <button class="btn btn-excel" onclick="exportExcel()"><i class="fas fa-file-excel"></i> Xu·∫•t Excel</button>
            <button id="btn-sync" class="btn btn-sync" onclick="manualSync()"><i class="fas fa-sync-alt"></i> L√ÄM M·ªöI DANH M·ª§C</button>
            <button id="btn-snap-kh" class="btn btn-save" style="display:none;" onclick="saveSnapshot('ke_hoach', 'KH')"><i class="fas fa-calendar-check"></i> Ch·ªët K·∫ø Ho·∫°ch</button>
            <button id="btn-snap-kq" class="btn btn-save" style="display:none;" onclick="saveSnapshot('kq_hieu_chuan', 'KQ')"><i class="fas fa-check-double"></i> Ch·ªët K·∫øt Qu·∫£</button>
            
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="search" class="search-input" placeholder="T√¨m ki·∫øm..." oninput="render()">
            </div>
        </div>
        <div class="table-container">
            <table><thead id="thead"></thead><tbody id="tbody"></tbody></table>
        </div>
    </div>
</div>

<script>
let currentMode="", currentKey="", currentGroup="", currentData=[];
let selectedIndex = -1;
let isSyncing = false; // C·ªù ngƒÉn ch·∫∑n render khi ƒëang ƒë·ªìng b·ªô

const GROUPS_CHINH = ["Huy·∫øt h·ªçc", "Mi·ªÖn d·ªãch", "Sinh h√≥a", "Vi sinh", "SHPT"];
const GROUPS_PHU = ["M√°y ly t√¢m", "T·ªß l·∫°nh", "T·ªß √¢m s√¢u", "Nhi·ªát k·∫ø", "Nhi·ªát k·∫ø ph√≤ng", "T·ªß ATSH", "Pipette", "N·ªìi h·∫•p", "T·ªß ·∫•m", "Kh√°c"];

const COLS = {
    dstong: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Model","Serial","V·ªã tr√≠","S·∫£n xu·∫•t","Cung ·ª©ng","Li√™n h·ªá","Ph·ª• tr√°ch"],
    tbchinh: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Model","Serial","V·ªã tr√≠","S·∫£n xu·∫•t","Cung ·ª©ng","Li√™n h·ªá","T√¨nh tr·∫°ng","Ph·ª• tr√°ch"],
    dstongphu: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Ch·ªßng lo·∫°i","Serial","Nh√† s·∫£n xu·∫•t","N∆∞·ªõc","Ng√†y l·∫Øp","V·ªã tr√≠","T√¨nh tr·∫°ng"],
    tbphu: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Ch·ªßng lo·∫°i","Serial","Nh√† s·∫£n xu·∫•t","N∆∞·ªõc","Ng√†y l·∫Øp","V·ªã tr√≠","T√¨nh tr·∫°ng"],
    kqhc: ["M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Model","Serial","Ng√†y hi·ªáu chu·∫©n","Ng√†y ti·∫øp theo","K·∫øt qu·∫£","ƒê∆°n v·ªã","Ghi ch√∫"],
    kehoach: ["M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Serial","Th·ªùi gian th·ª±c hi·ªán","N·ªôi dung y√™u c·∫ßu","Ti√™u ch√≠ ch·∫•p nh·∫≠n","Ghi ch√∫"]
};

function toggleSubmenu(id, element) {
    const sub = document.getElementById(id);
    sub.style.display = sub.style.display === "block" ? "none" : "block";
    element.querySelector('.arrow').classList.toggle('rotated');
}

function loadData(key, title, mode, group = "") {
    currentKey = key; currentMode = mode; currentGroup = group; selectedIndex = -1;
    document.getElementById("title").innerText = title;
    document.getElementById("btn-sync").style.display = (mode === 'dstong' || mode === 'dstongphu') ? "flex" : "none";
    document.getElementById("btn-snap-kh").style.display = (key === 'ke_hoach/Goc') ? "flex" : "none";
    document.getElementById("btn-snap-kq").style.display = (key === 'kq_hieu_chuan/Goc') ? "flex" : "none";

    window.dbOnValue(window.dbRef(window.db, window.dbPath + key), (snap) => {
        // Ch·ªâ v·∫Ω l·∫°i n·∫øu kh√¥ng ph·∫£i do h√†nh ƒë·ªông Sync g√¢y ra ho·∫∑c key tr√πng kh·ªõp
        if (isSyncing) return;
        const val = snap.val();
        currentData = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
        render();
    });
}

function render() {
    const cols = COLS[currentMode] || [];
    const q = (document.getElementById("search")?.value || "").toLowerCase();
    const tbody = document.getElementById("tbody");
    document.getElementById("thead").innerHTML = `<tr><th style="width:50px">STT</th>${cols.map(c => `<th>${c}</th>`).join("")}<th style="width:50px">X√≥a</th></tr>`;
    tbody.innerHTML = "";
    
    currentData.forEach((row, index) => {
        if (!row) return; 
        if(q && !Object.values(row).some(v => String(v).toLowerCase().includes(q))) return;
        
        const tr = document.createElement("tr");
        if (index === selectedIndex) tr.classList.add('selected');
        tr.onclick = () => { selectedIndex = index; document.querySelectorAll('tr').forEach(r => r.classList.remove('selected')); tr.classList.add('selected'); };

        let html = `<td>${index+1}</td>`;
        cols.forEach((c, colIndex) => {
            const isReadonly = (c === "Nh√≥m" && (currentMode === 'tbchinh' || currentMode === 'tbphu')) ? 'contenteditable="false" style="background:#f8fafc;"' : 'contenteditable="true"';
            html += `<td ${isReadonly} onblur="updateCell(${index},'${c}',this.innerText)" onpaste="handlePaste(event, ${index}, ${colIndex})">${row[c]||""}</td>`;
        });
        html += `<td><i class="fas fa-trash-alt" style="color:#f87171; cursor:pointer" onclick="deleteRow(${index})"></i></td>`;
        tr.innerHTML = html;
        tbody.appendChild(tr);
    });
}

async function manualSync() {
    if(!confirm("ƒê·ªìng b·ªô d·ªØ li·ªáu xu·ªëng c√°c nh√≥m con?")) return;
    isSyncing = true; // B·∫≠t c·ªù ƒë·ªìng b·ªô
    const btn = document.getElementById("btn-sync");
    btn.disabled = true; btn.innerText = "ƒêang x·ª≠ l√Ω...";

    try {
        if (currentMode === 'dstong') await syncAll('dstong', 'tb_chinh', GROUPS_CHINH);
        if (currentMode === 'dstongphu') await syncAll('dstongphu', 'tb_phu', GROUPS_PHU);
        alert("Th√†nh c√¥ng!");
    } finally {
        isSyncing = false; // T·∫Øt c·ªù
        btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync-alt"></i> L√ÄM M·ªöI DANH M·ª§C';
        render(); // V·∫Ω l·∫°i l·∫ßn cu·ªëi ƒë·ªÉ ƒë·∫£m b·∫£o kh·ªõp d·ªØ li·ªáu
    }
}

async function handlePaste(e, startRowIdx, startColIdx) {
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData('text/plain');
    if (!text) return;
    const rows = text.split(/\r\n|\n|\r/).filter(row => row.length > 0);
    const colsList = COLS[currentMode];
    rows.forEach((rowText, rOffset) => {
        let currentRowIdx = startRowIdx + rOffset;
        if (currentRowIdx < currentData.length) {
            const cellValues = rowText.split('\t');
            cellValues.forEach((val, cOffset) => {
                let currentColIdx = startColIdx + cOffset;
                if (currentColIdx < colsList.length) {
                    let colName = colsList[currentColIdx];
                    if (!(colName === "Nh√≥m" && (currentMode === 'tbchinh' || currentMode === 'tbphu'))) {
                        currentData[currentRowIdx][colName] = val.trim();
                    }
                }
            });
        }
    });
    await safeSave(currentKey, currentData);
    render();
}

async function updateCell(index, col, val) {
    const newVal = val.trim();
    if (currentData[index][col] === newVal) return;
    currentData[index][col] = newVal;
    await safeSave(currentKey, currentData);
}

async function safeSave(key, data) {
    const cleanData = data.filter(item => item !== null);
    await window.dbSet(window.dbRef(window.db, window.dbPath + key), cleanData);
}

async function syncAll(masterMode, folder, groups) {
    let buckets = {};
    groups.forEach(g => buckets[g] = []);
    currentData.forEach(item => {
        if (!item) return;
        const itemGrp = (item["Nh√≥m"] || "").trim();
        let found = groups.find(g => g.toLowerCase() === itemGrp.toLowerCase());
        if (found) {
            let row = {};
            const subCols = COLS[masterMode === 'dstong' ? 'tbchinh' : 'tbphu'];
            subCols.forEach(c => row[c] = item[c] || "");
            row["Nh√≥m"] = found;
            buckets[found].push(row);
        }
    });
    for (const g of groups) await safeSave(`${folder}/${g}`, buckets[g]);
}

async function addRowAtPosition() {
    let obj = {}; 
    COLS[currentMode].forEach(c => obj[c] = (c === "Nh√≥m" ? currentGroup : ""));
    if (selectedIndex !== -1) currentData.splice(selectedIndex + 1, 0, obj);
    else currentData.push(obj);
    await safeSave(currentKey, currentData);
}

async function deleteRow(index) {
    if(!confirm("X√°c nh·∫≠n x√≥a?")) return;
    currentData.splice(index, 1); selectedIndex = -1;
    await safeSave(currentKey, currentData);
}

async function saveSnapshot(folder, prefix) {
    const d = new Date();
    const name = prompt("T√™n phi√™n b·∫£n l∆∞u:", `${prefix}_${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}`);
    if(!name) return;
    const dataCopy = JSON.parse(JSON.stringify(currentData.filter(i => i !== null)));
    await safeSave(`${folder}/Archives/${name}`, dataCopy);
}

function initArchives() {
    window.dbOnValue(window.dbRef(window.db, window.dbPath + 'ke_hoach/Archives'), (snap) => renderArchives(snap.val(), 'archive_kh_list', 'ke_hoach', 'kehoach'));
    window.dbOnValue(window.dbRef(window.db, window.dbPath + 'kq_hieu_chuan/Archives'), (snap) => renderArchives(snap.val(), 'archive_kq_list', 'kq_hieu_chuan', 'kqhc'));
}

function renderArchives(data, id, folder, mode) {
    const div = document.getElementById(id); div.innerHTML = "";
    if(data) Object.keys(data).forEach(k => {
        const item = document.createElement("div"); item.className="sub-item";
        item.innerHTML = `<span style="flex-grow:1" onclick="loadData('${folder}/Archives/${k}','B·∫¢N L∆ØU: ${k}','${mode}')"><i class="fas fa-file-alt"></i> ${k}</span>
            <div style="display:flex; gap:8px;"><i class="fas fa-edit" style="color:#fbbf24; cursor:pointer" onclick="renameArchive('${folder}','${k}')"></i>
            <i class="fas fa-times" style="color:#f87171; cursor:pointer" onclick="deleteArchive('${folder}','${k}')"></i></div>`;
        div.appendChild(item);
    });
}

async function deleteArchive(f, k) { if(confirm(`X√≥a?`)) await window.dbRemove(window.dbRef(window.db, window.dbPath + `${f}/Archives/${k}`)); }
async function renameArchive(f, oldK) {
    const newK = prompt("T√™n m·ªõi:", oldK); if(!newK || newK === oldK) return;
    const oldRef = window.dbRef(window.db, window.dbPath + `${f}/Archives/${oldK}`);
    window.dbOnValue(oldRef, async (snap) => { await window.dbSet(window.dbRef(window.db, window.dbPath + `${f}/Archives/${newK}`), snap.val()); await window.dbRemove(oldRef); }, { onlyOnce: true });
}

function exportExcel() {
    const ws = XLSX.utils.json_to_sheet(currentData.filter(i => i !== null));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "D·ªØ li·ªáu");
    XLSX.writeFile(wb, `LabData_${new Date().getTime()}.xlsx`);
}

window.onload = () => { initArchives(); loadData('ds_tong', 'üì¶ T·ªîNG THI·∫æT B·ªä CH√çNH', 'dstong'); };
</script>
</body>
</html>
