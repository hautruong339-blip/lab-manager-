<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAB MANAGER - FIREBASE M·ªöI</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // C·∫•u h√¨nh Firebase li√™n k·∫øt v·ªõi ƒë·ªãa ch·ªâ b·∫°n cung c·∫•p
        const firebaseConfig = {
            databaseURL: "https://tbkxnub-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ƒê·ªäA CH·ªà L∆ØU TR·ªÆ CHI TI·∫æT THEO Y√äU C·∫¶U
        window.dbPath = "users/-OiHXtd0s_Vjtd2VM2fN/name/";
        
        window.db = db; 
        window.dbRef = ref; 
        window.dbSet = set; 
        window.dbOnValue = onValue; 
        window.dbRemove = remove;
    </script>

    <style>
        :root { --primary: #1e3a8a; --secondary: #059669; --white: #ffffff; }
        * { box-sizing: border-box; font-family: "Times New Roman", Times, serif; }
        body { margin: 0; background: #f0f2f5; display: flex; }

        /* Sidebar */
        .sidebar { width: 300px; height: 100vh; position: fixed; background: #001a4d; padding: 15px; overflow-y: auto; color: white; border-right: 3px solid var(--primary); }
        .logo-box { text-align: center; margin-bottom: 25px; border-bottom: 1px solid #2d4a8a; padding-bottom: 15px; }
        .logo-box img { width: 60px; background: white; border-radius: 50%; padding: 5px; }
        .brand-name { display: block; font-size: 18px; font-weight: bold; margin-top: 10px; color: #3b82f6; }

        .menu-card { padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-weight: bold; transition: 0.3s; }
        .btn-orange { background: #d97706; } .btn-blue { background: #2563eb; } .btn-purple { background: #7c3aed; }

        .submenu { display: none; padding-left: 15px; margin-bottom: 10px; border-left: 2px solid #3b82f6; }
        .sub-item { padding: 10px; border-radius: 6px; margin-bottom: 5px; cursor: pointer; font-size: 14px; background: #1e3a8a; color: white; display: flex; align-items: center; justify-content: space-between; }
        .sub-item:hover { background: #3b82f6; }

        /* Main Area */
        .main { margin-left: 300px; padding: 30px; width: calc(100% - 300px); }
        .top-banner { background: linear-gradient(135deg, #1e3a8a, #059669); padding: 25px; border-radius: 12px; color: white; margin-bottom: 25px; text-align: center; }
        .content-box { background: var(--white); border-radius: 10px; padding: 20px; border: 1px solid #cbd5e1; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .toolbar { display: flex; gap: 12px; margin-bottom: 20px; align-items: center; }
        .btn { padding: 10px 18px; border-radius: 6px; font-weight: bold; border: none; cursor: pointer; display: flex; align-items: center; gap: 8px; color: white; }
        .btn-add { background: var(--primary); } .btn-excel { background: var(--secondary); } .btn-save { background: #f59e0b; }

        .search-input { flex-grow: 1; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; }

        .table-container { overflow-x: auto; max-height: 65vh; border: 1px solid #cbd5e1; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; }
        th { background: #f1f5f9; color: #0f172a; padding: 14px; border: 1px solid #cbd5e1; position: sticky; top: 0; z-index: 10; font-size: 14px; }
        td { padding: 12px; border: 1px solid #cbd5e1; text-align: center; background: white; font-size: 14px; }
        
        .arrow { font-size: 10px; transition: 0.3s; }
        .rotated { transform: rotate(90deg); }
        .nav-label { font-size: 12px; font-weight: bold; color: #94a3b8; margin: 25px 0 10px 0; text-transform: uppercase; }
    </style>
</head>

<body>

<div class="sidebar">
    <div class="logo-box">
        <img src="https://bvub.vn/wp-content/uploads/2021/05/logo-ub.png" alt="Logo">
        <span class="brand-name">LAB MANAGER</span>
    </div>

    <div class="menu-card btn-orange" onclick="loadData('ds_tong', 'üì¶ T·ªîNG DANH M·ª§C CH√çNH', 'dstong')">
        <span><i class="fas fa-list-ul"></i> T·ªîNG DM CH√çNH</span>
    </div>

    <div class="menu-card btn-blue" onclick="toggleSubmenu('sub_chinh', this)">
        <span><i class="fas fa-microscope"></i> THI·∫æT B·ªä CH√çNH</span>
        <span class="arrow">‚ñ∂</span>
    </div>
    <div id="sub_chinh" class="submenu">
        <div class="sub-item" onclick="loadData('tb_chinh/Huy·∫øt h·ªçc', 'ü©∏ HUY·∫æT H·ªåC', 'tbchinh', 'Huy·∫øt h·ªçc')">Huy·∫øt h·ªçc</div>
        <div class="sub-item" onclick="loadData('tb_chinh/Mi·ªÖn d·ªãch', 'üß´ MI·ªÑN D·ªäCH', 'tbchinh', 'Mi·ªÖn d·ªãch')">Mi·ªÖn d·ªãch</div>
        <div class="sub-item" onclick="loadData('tb_chinh/Sinh h√≥a', '‚öóÔ∏è SINH H√ìA', 'tbchinh', 'Sinh h√≥a')">Sinh h√≥a</div>
        <div class="sub-item" onclick="loadData('tb_chinh/Vi sinh', 'ü¶† VI SINH', 'tbchinh', 'Vi sinh')">Vi sinh</div>
        <div class="sub-item" onclick="loadData('tb_chinh/SHPT', 'üß¨ SHPT', 'tbchinh', 'SHPT')">SHPT</div>
    </div>

    <div class="menu-card btn-purple" onclick="loadData('ds_tong_phu', 'üõ†Ô∏è T·ªîNG THI·∫æT B·ªä PH·ª§', 'dstongphu')">
        <span><i class="fas fa-tools"></i> T·ªîNG THI·∫æT B·ªä PH·ª§</span>
    </div>

    <div class="menu-card btn-blue" onclick="toggleSubmenu('sub_phu', this)">
        <span><i class="fas fa-toolbox"></i> THI·∫æT B·ªä PH·ª§</span>
        <span class="arrow">‚ñ∂</span>
    </div>
    <div id="sub_phu" class="submenu">
        <div class="sub-item" onclick="loadData('tb_phu/M√°y ly t√¢m', 'üîÑ M√ÅY LY T√ÇM', 'tbphu', 'M√°y ly t√¢m')">M√°y ly t√¢m</div>
        <div class="sub-item" onclick="loadData('tb_phu/T·ªß l·∫°nh', '‚ùÑÔ∏è T·ª¶ L·∫†NH', 'tbphu', 'T·ªß l·∫°nh')">T·ªß l·∫°nh</div>
        <div class="sub-item" onclick="loadData('tb_phu/T·ªß √¢m s√¢u', 'üßä T·ª¶ √ÇM S√ÇU', 'tbphu', 'T·ªß √¢m s√¢u')">T·ªß √¢m s√¢u</div>
        <div class="sub-item" onclick="loadData('tb_phu/Nhi·ªát k·∫ø', 'üå°Ô∏è NHI·ªÜT K·∫æ', 'tbphu', 'Nhi·ªát k·∫ø')">Nhi·ªát k·∫ø HC</div>
        <div class="sub-item" onclick="loadData('tb_phu/Nhi·ªát k·∫ø ph√≤ng', 'üè† NHI·ªÜT K·∫æ PH√íNG', 'tbphu', 'Nhi·ªát k·∫ø ph√≤ng')">Nhi·ªát k·∫ø ph√≤ng</div>
        <div class="sub-item" onclick="loadData('tb_phu/T·ªß ATSH', 'üõ°Ô∏è T·ª¶ ATSH', 'tbphu', 'T·ªß ATSH')">T·ªß ATSH</div>
        <div class="sub-item" onclick="loadData('tb_phu/Pipette', 'üß™ PIPETTE', 'tbphu', 'Pipette')">Pipette</div>
        <div class="sub-item" onclick="loadData('tb_phu/N·ªìi h·∫•p', '‚ô®Ô∏è N·ªíI H·∫§P', 'tbphu', 'N·ªìi h·∫•p')">N·ªìi h·∫•p</div>
        <div class="sub-item" onclick="loadData('tb_phu/T·ªß ·∫•m', 'üì¶ T·ª¶ ·∫§M', 'tbphu', 'T·ªß ·∫•m')">T·ªß ·∫•m</div>
    </div>

    <div class="nav-label">K·∫ø Ho·∫°ch & K·∫øt Qu·∫£</div>
    <div class="sub-item" onclick="loadData('ke_hoach/Goc', 'üìÖ SO·∫†N TH·∫¢O K·∫æ HO·∫†CH', 'kehoach')"><b>üìÖ So·∫°n th·∫£o KH</b></div>
    <div id="archive_kh_list"></div>
    <div class="sub-item" onclick="loadData('kq_hieu_chuan/Goc', 'üìä SO·∫†N TH·∫¢O K·∫æT QU·∫¢', 'kqhc')"><b>üìä So·∫°n th·∫£o KQ</b></div>
    <div id="archive_kq_list"></div>
</div>

<div class="main">
    <div class="top-banner">
        <h1 id="title">H·ªá Th·ªëng Qu·∫£n L√Ω Khoa XN</h1>
        <p>B·ªánh vi·ªán Ung B∆∞·ªõu TP.HCM - C∆° s·ªü 2</p>
    </div>

    <div class="content-box">
        <div class="toolbar">
            <button class="btn btn-add" onclick="addRow()"><i class="fas fa-plus"></i> Th√™m D√≤ng</button>
            <button class="btn btn-excel" onclick="exportExcel()"><i class="fas fa-file-excel"></i> Xu·∫•t Excel</button>
            <button id="btn-snap-kh" class="btn btn-save" style="display:none;" onclick="saveSnapshot('ke_hoach', 'KH')"><i class="fas fa-save"></i> Ch·ªët KH</button>
            <button id="btn-snap-kq" class="btn btn-save" style="display:none;" onclick="saveSnapshot('kq_hieu_chuan', 'KQ')"><i class="fas fa-save"></i> Ch·ªët KQ</button>
            <input type="text" id="search" class="search-input" placeholder="T√¨m ki·∫øm nhanh..." oninput="render()">
        </div>
        <div class="table-container">
            <table><thead id="thead"></thead><tbody id="tbody"></tbody></table>
        </div>
    </div>
</div>

<script>
let currentMode="", currentKey="", currentGroup="", currentData=[];

const GROUPS_CHINH = ["Huy·∫øt h·ªçc", "Mi·ªÖn d·ªãch", "Sinh h√≥a", "Vi sinh", "SHPT"];
const GROUPS_PHU = ["M√°y ly t√¢m", "T·ªß l·∫°nh", "T·ªß √¢m s√¢u", "Nhi·ªát k·∫ø", "Nhi·ªát k·∫ø ph√≤ng", "T·ªß ATSH", "Pipette", "N·ªìi h·∫•p", "T·ªß ·∫•m"];

const COLS = {
    dstong: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Model","Serial","V·ªã tr√≠","S·∫£n xu·∫•t","Cung ·ª©ng","Li√™n h·ªá","Ph·ª• tr√°ch"],
    tbchinh: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Model","Serial","V·ªã tr√≠","S·∫£n xu·∫•t","Cung ·ª©ng","Li√™n h·ªá","T√¨nh tr·∫°ng","Ph·ª• tr√°ch"],
    dstongphu: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Ch·ªßng lo·∫°i","Serial","Nh√† s·∫£n xu·∫•t","N∆∞·ªõc","Ng√†y l·∫Øp","V·ªã tr√≠","T√¨nh tr·∫°ng"],
    tbphu: ["Nh√≥m","M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Ch·ªßng lo·∫°i","Serial","Nh√† s·∫£n xu·∫•t","N∆∞·ªõc","Ng√†y l·∫Øp","V·ªã tr√≠","T√¨nh tr·∫°ng"],
    kqhc: ["M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Model","Serial","Ng√†y hi·ªáu chu·∫©n","Ng√†y ti·∫øp theo","K·∫øt qu·∫£","ƒê∆°n v·ªã","Ghi ch√∫"],
    kehoach: ["M√£ thi·∫øt b·ªã","T√™n thi·∫øt b·ªã","Serial","Th·ªùi gian th·ª±c hi·ªán","N·ªôi dung y√™u c·∫ßu","Ti√™u ch√≠ ch·∫•p nh·∫≠n","Ghi ch√∫"]
};

function toggleSubmenu(id, element) {
    const sub = document.getElementById(id);
    const arrow = element.querySelector('.arrow');
    sub.style.display = (sub.style.display === "block") ? "none" : "block";
    arrow.classList.toggle('rotated');
}

function loadData(key, title, mode, group = "") {
    currentKey = key; currentMode = mode; currentGroup = group;
    document.getElementById("title").innerText = title;
    
    document.getElementById("btn-snap-kh").style.display = (key === 'ke_hoach/Goc') ? "flex" : "none";
    document.getElementById("btn-snap-kq").style.display = (key === 'kq_hieu_chuan/Goc') ? "flex" : "none";

    window.dbOnValue(window.dbRef(window.db, window.dbPath + key), (snap) => {
        const val = snap.val();
        if (val && typeof val === 'object' && !Array.isArray(val)) {
            currentData = Object.values(val);
        } else {
            currentData = val || [];
        }
        render();
    });
}

function render() {
    const cols = COLS[currentMode] || [];
    const q = (document.getElementById("search")?.value || "").toLowerCase();
    const tbody = document.getElementById("tbody");
    document.getElementById("thead").innerHTML = `<tr><th>STT</th>${cols.map(c => `<th>${c}</th>`).join("")}<th>X√≥a</th></tr>`;
    tbody.innerHTML = "";
    
    let stt = 1;
    currentData.forEach((row, index) => {
        if (!row) return; 
        if(q && !Object.values(row).some(v => String(v).toLowerCase().includes(q))) return;
        
        const tr = document.createElement("tr");
        let html = `<td><b>${stt++}</b></td>`;
        cols.forEach(c => {
            const isReadonly = (c === "Nh√≥m" && (currentMode === 'tbchinh' || currentMode === 'tbphu')) ? 'contenteditable="false" style="background:#f8fafc"' : 'contenteditable="true"';
            html += `<td ${isReadonly} onblur="updateCell(${index},'${c}',this.innerText)">${row[c]||""}</td>`;
        });
        html += `<td><i class="fas fa-trash-alt" style="color:red; cursor:pointer" onclick="deleteRow(${index})"></i></td>`;
        tr.innerHTML = html;
        tbody.appendChild(tr);
    });
}

async function updateCell(index, col, val) {
    const newVal = val.trim();
    if (currentData[index][col] === newVal) return;
    
    currentData[index][col] = newVal;
    
    await safeSave(currentKey, currentData);

    if (currentMode === 'dstong') {
        syncAll('dstong', 'tb_chinh', GROUPS_CHINH);
    } else if (currentMode === 'dstongphu') {
        syncAll('dstongphu', 'tb_phu', GROUPS_PHU);
    }
}

async function safeSave(key, data) {
    if (!key) return;
    const cleanData = data.filter(item => item !== null);
    await window.dbSet(window.dbRef(window.db, window.dbPath + key), cleanData);
}

async function syncAll(masterMode, folder, groups) {
    let buckets = {};
    groups.forEach(g => buckets[g] = []);

    currentData.forEach(item => {
        if (!item) return;
        const itemGrp = (item["Nh√≥m"] || "").trim().toLowerCase();
        const found = groups.find(g => g.toLowerCase() === itemGrp);
        if (found) {
            let row = {};
            const subCols = COLS[masterMode === 'dstong' ? 'tbchinh' : 'tbphu'];
            subCols.forEach(c => row[c] = item[c] || "");
            row["Nh√≥m"] = found;
            buckets[found].push(row);
        }
    });

    for (const g of groups) {
        await safeSave(`${folder}/${g}`, buckets[g]);
    }
}

async function addRow() {
    let obj = {}; 
    COLS[currentMode].forEach(c => obj[c] = (c === "Nh√≥m" ? currentGroup : ""));
    currentData.push(obj);
    await safeSave(currentKey, currentData);
}

async function deleteRow(index) {
    if(!confirm("X√≥a d√≤ng n√†y?")) return;
    currentData.splice(index, 1);
    await safeSave(currentKey, currentData);
    
    if (currentMode === 'dstong') syncAll('dstong', 'tb_chinh', GROUPS_CHINH);
    if (currentMode === 'dstongphu') syncAll('dstongphu', 'tb_phu', GROUPS_PHU);
}

async function saveSnapshot(folder, prefix) {
    const d = new Date();
    const name = prompt("T√™n t·ªáp l∆∞u:", `${prefix} - ${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}`);
    if(!name) return;
    const dataCopy = JSON.parse(JSON.stringify(currentData.filter(i => i !== null)));
    await safeSave(`${folder}/Archives/${name}`, dataCopy);
}

function loadArchives() {
    window.dbOnValue(window.dbRef(window.db, window.dbPath + 'ke_hoach/Archives'), (snap) => renderArchives(snap.val(), 'archive_kh_list', 'ke_hoach', 'kehoach'));
    window.dbOnValue(window.dbRef(window.db, window.dbPath + 'kq_hieu_chuan/Archives'), (snap) => renderArchives(snap.val(), 'archive_kq_list', 'kq_hieu_chuan', 'kqhc'));
}

function renderArchives(data, id, folder, mode) {
    const div = document.getElementById(id); div.innerHTML = "";
    if(data) Object.keys(data).forEach(k => {
        const item = document.createElement("div"); item.className="sub-item";
        item.innerHTML = `<span style="flex-grow:1" onclick="loadData('${folder}/Archives/${k}','B·∫¢N L∆ØU: ${k}','${mode}')">${k}</span>
                          <i class="fas fa-trash" style="font-size:11px;cursor:pointer" onclick="deleteArchive('${folder}','${k}')"></i>`;
        div.appendChild(item);
    });
}

async function deleteArchive(f, k) {
    if(confirm(`X√≥a b·∫£n l∆∞u ${k}?`)) await window.dbRemove(window.dbRef(window.db, window.dbPath + `${f}/Archives/${k}`));
}

function exportExcel() {
    const ws = XLSX.utils.json_to_sheet(currentData.filter(i => i !== null));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "LabData");
    XLSX.writeFile(wb, "LabManager.xlsx");
}

window.onload = () => { loadArchives(); loadData('ds_tong', 'üì¶ T·ªîNG DANH M·ª§C CH√çNH', 'dstong'); };
</script>
</body>
</html>
